<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>腓利門雲POS - 旗艦完整版</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        /* =========================================
           1. 全局基礎樣式
           ========================================= */
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            background-color: #F5F5DC; /* 米色背景 */
            color: #333;
        }

        * {
            box-sizing: border-box; /* 確保寬度計算包含 padding */
        }

        /* 父級容器：響應式佈局 */
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            width: 100%;
            max-width: 1280px; /* 加寬一點 */
            margin-top: 20px;
            padding: 0 15px;
        }

        /* 左右區塊容器 */
        .container-half {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 49%; /* 讓左右更緊湊 */
            margin-bottom: 20px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        /* =========================================
           2. 通用元件 (Header, Input, Table)
           ========================================= */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 15px;
        }

        .header h2 {
            margin: 0;
            color: #8B4513; /* 深褐色 */
            font-size: 1.4em;
        }

        /* 按鈕群組樣式 */
        .btn-group button {
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            color: white;
            margin-left: 5px;
            transition: opacity 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-group button:hover { opacity: 0.9; }

        /* 各種功能按鈕顏色 */
        #backup-btn { background-color: #4682B4; } /* 鋼藍 */
        #restore-btn { background-color: #20B2AA; } /* 海洋綠 */
        #reset-mem-btn { background-color: #FF8C00; } /* 深橘 (清除記憶) */
        #export-csv-btn { background-color: #2E8B57; } /* 海綠 */
        #clear-all-btn { background-color: #A52A2A; } /* 紅褐色 (危險) */

        /* 輸入框區域 */
        .form-group {
            margin-bottom: 15px;
            background-color: #FFF8DC; /* 淡米黃 */
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #DEB887;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #8B4513;
        }

        input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 10px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        input:focus {
            outline: none;
            border-color: #8B4513;
            box-shadow: 0 0 5px rgba(139, 69, 19, 0.3);
        }

        /* 表格容器 */
        .table-container {
            flex-grow: 1;
            overflow-x: auto;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #F5F5F5;
            color: #555;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        /* 購物車內的輸入框縮小 */
        td input[type="number"] {
            padding: 5px;
            font-size: 1em;
            text-align: center;
        }

        /* =========================================
           3. 智慧折扣專屬樣式 (Smart Discount UI)
           ========================================= */
        
        /* 包裹折扣輸入框與功能的容器 */
        .discount-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        /* [狀態一] 單品永久記憶：紅色框 + 紅色背景 */
        .status-memory {
            border: 2px solid #d9534f !important;
            background-color: #fdf2f2 !important;
            color: #c9302c;
            font-weight: bold;
        }

        /* [狀態二] 分類規則同步：綠色框 + 綠色背景 */
        .status-rule {
            border: 2px solid #5cb85c !important;
            background-color: #f0fdf4 !important;
            color: #3c763d;
            font-weight: bold;
        }

        /* 清除記憶的小按鈕 (X) */
        .clear-mem-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 14px;
            margin-left: 5px;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 50%;
        }
        .clear-mem-btn:hover {
            background-color: #ffe6e6;
            color: red;
        }

        /* 狀態標籤 (顯示在商品名稱旁) */
        .status-badge {
            font-size: 0.7em;
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 5px;
            color: white;
            vertical-align: text-top;
        }
        .badge-mem { background-color: #d9534f; }
        .badge-rule { background-color: #5cb85c; }

        /* 同步勾選框 (Focus 時顯示) */
        .sync-container {
            display: none; /* 預設隱藏 */
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #fffbe6;
            border: 1px solid #d2b48c;
            padding: 5px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            border-radius: 0 0 4px 4px;
        }
        
        .discount-wrapper:focus-within .sync-container {
            display: block; /* 輸入框被點擊時顯示 */
        }

        /* =========================================
           4. 結帳區與統計
           ========================================= */
        .total-section {
            background-color: #8A6739;
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            text-align: right;
            margin-top: auto;
        }
        .total-amount { font-size: 2em; font-weight: bold; }

        .payment-section {
            background-color: white;
            border: 2px solid #8A6739;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 15px;
        }

        .pay-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #555;
        }

        .checkout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .checkout-btn {
            background-color: #8A6739;
            color: #FFF8DC;
            border: none;
            padding: 15px 5px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s, background-color 0.2s;
        }
        .checkout-btn:hover { background-color: #6d522d; transform: translateY(-2px); }
        .checkout-btn:active { transform: translateY(0); }
        
        .btn-key { font-size: 1.6em; font-weight: 900; margin-bottom: 5px; }
        .btn-desc { font-size: 0.9em; opacity: 0.9; }

        /* 搜尋結果列表 */
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            margin-top: 5px;
            background: white;
            display: none; /* 有內容才顯示 */
        }
        .search-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }
        .search-item:hover { background-color: #f0f0f0; }

        /* 響應式調整 */
        @media (max-width: 768px) {
            .container-half { width: 100%; }
            .checkout-grid { grid-template-columns: 1fr 1fr; }
        }

        /* 動畫 */
        .pulse-anim { animation: pulse 0.3s ease-in-out; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
    </style>
</head>
<body>
    <input type="file" id="import-file" accept=".json" style="display: none;">

    <div class="flex-container">
        <div class="container-half">
            <div class="header">
                <div>
                    <img src="image/logo.png" alt="Logo" style="height: 35px; vertical-align: middle; margin-right: 10px;" onerror="this.style.display='none'">
                    <span>腓利門雲POS</span>
                </div>
                <div id="date-display" style="font-size:0.9em; color:#666;"></div>
            </div>

            <div class="form-group" style="background:none; border:none; padding:0; text-align:center;">
                <div class="btn-group">
                    <button id="backup-btn" title="下載備份檔">備份資料</button>
                    <button id="restore-btn" title="讀取備份檔">還原資料</button>
                    <button id="reset-mem-btn" title="清除所有手動特價紀錄">清除記憶</button>
                    <button id="export-csv-btn" title="匯出Excel報表">匯出報表</button>
                    <button id="clear-all-btn" title="刪除所有訂單">系統重置</button>
                </div>
            </div>

            <div class="form-group">
                <label for="product-code">商品條碼 / 代碼掃描：</label>
                <input type="text" id="product-code" placeholder="請掃描條碼或輸入代碼" autocomplete="off">
                <div id="scan-feedback" style="margin-top:5px; height:20px; font-weight:bold; color:#2E8B57;"></div>
            </div>

            <div class="form-group">
                <label for="keyword-search">關鍵字搜尋：</label>
                <input type="text" id="keyword-search" placeholder="輸入名稱、代碼或條碼搜尋">
                <div id="search-results" class="search-results"></div>
            </div>
            
            <div id="csv-status" style="text-align:right; font-size:0.8em; color:#999;">CSV 狀態: 準備中</div>
        </div>

        <div class="container-half">
            <div class="header">
                <h2>購物清單</h2>
            </div>
            
            <div class="table-container">
                <table id="cart-table">
                    <thead>
                        <tr>
                            <th>品名 / 規格</th>
                            <th style="width:70px;">單價</th>
                            <th style="width:60px;">數量</th>
                            <th style="width:140px;">折扣%</th>
                            <th style="width:80px;">小計</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>

            <div class="total-section">
                總金額：<span id="total-amount" class="total-amount">0</span> 元
            </div>

            <div class="payment-section">
                <div class="pay-row">
                    <span>實收金額：</span>
                    <input type="number" id="paid-amount" value="1000">
                </div>
                <div class="pay-row" style="border-bottom: 1px dashed #ccc; padding-bottom:10px;">
                    <span>找零：</span>
                    <span id="change-amount" style="color:#A52A2A; font-weight:bold;">0</span> 元
                </div>

                <div class="checkout-grid">
                    <button id="btn-card" class="checkout-btn">
                        <span class="btn-key">F7</span><span class="btn-desc">信用卡</span>
                    </button>
                    <button id="btn-line" class="checkout-btn">
                        <span class="btn-key">F8</span><span class="btn-desc">LINE Pay</span>
                    </button>
                    <button id="btn-coin" class="checkout-btn">
                        <span class="btn-key">F9</span><span class="btn-desc">文化幣</span>
                    </button>
                    <button id="btn-cash" class="checkout-btn">
                        <span class="btn-key">F10</span><span class="btn-desc">現金</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-container">
        <div class="container-half">
            <div class="header"><h2>當日交易紀錄</h2></div>
            <div class="table-container">
                <table id="order-table">
                    <thead>
                        <tr>
                            <th>單號</th>
                            <th>金額</th>
                            <th>支付方式</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="padding:10px; font-size:0.9em; color:#666;">
                訂單數: <span id="order-count">0</span> | 平均客單: <span id="avg-order">0</span>
                <div id="payment-stats" style="margin-top:5px; padding-top:5px; border-top:1px dashed #ccc;"></div>
            </div>
        </div>

        <div class="container-half">
            <div class="header"><h2>商品銷售統計</h2></div>
            <div class="table-container">
                <table id="item-stats-table">
                    <thead>
                        <tr>
                            <th>代碼</th>
                            <th>品名</th>
                            <th>數量</th>
                            <th>總額</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="total-section" style="border-radius:4px; margin-top:10px; font-size:1.2em; padding:10px;">
                總營收：<span id="revenue-total">0</span> 元
            </div>
        </div>
    </div>

    <textarea id="notes" style="display:none;"></textarea>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ============================================
            // 1. 全局變數與初始化
            // ============================================
            const elements = {
                date: document.getElementById('date-display'),
                codeIn: document.getElementById('product-code'),
                searchIn: document.getElementById('keyword-search'),
                searchResults: document.getElementById('search-results'),
                scanFeedback: document.getElementById('scan-feedback'),
                cartBody: document.querySelector('#cart-table tbody'),
                totalDisplay: document.getElementById('total-amount'),
                paidIn: document.getElementById('paid-amount'),
                changeDisplay: document.getElementById('change-amount'),
                orderBody: document.querySelector('#order-table tbody'),
                itemStatsBody: document.querySelector('#item-stats-table tbody'),
                revenueDisplay: document.getElementById('revenue-total'),
                orderCount: document.getElementById('order-count'),
                avgOrder: document.getElementById('avg-order'),
                paymentStats: document.getElementById('payment-stats'),
                csvStatus: document.getElementById('csv-status'),
                importFile: document.getElementById('import-file'),
                btns: {
                    backup: document.getElementById('backup-btn'),
                    restore: document.getElementById('restore-btn'),
                    resetMem: document.getElementById('reset-mem-btn'),
                    export: document.getElementById('export-csv-btn'),
                    clearAll: document.getElementById('clear-all-btn'),
                    card: document.getElementById('btn-card'),
                    line: document.getElementById('btn-line'),
                    coin: document.getElementById('btn-coin'),
                    cash: document.getElementById('btn-cash')
                }
            };

            // 資料狀態管理
            let store = {
                cart: JSON.parse(localStorage.getItem('cart')) || [],
                clients: JSON.parse(localStorage.getItem('clients')) || {},
                summary: JSON.parse(localStorage.getItem('summary')) || {},
                counter: JSON.parse(localStorage.getItem('counter')) || 1,
                
                // [核心功能] 單品記憶庫：記錄被手動修改過的商品折扣
                // 結構: { "CODE123": 50, "CODE456": 79 }
                itemMemory: JSON.parse(localStorage.getItem('itemMemory')) || {},

                // [核心功能] 分類規則庫：記錄被同步修改的分類折扣
                // 結構: { "09-1": 79, "02-1": 85 }
                sessionRules: JSON.parse(localStorage.getItem('sessionRules')) || {},

                products: {}, // 從 CSV 讀取
                
                // 預設分類折扣表
                defaultDiscounts: {
                    "POS": 100, "02-2": 100, "09-2": 90, "09-5": 100, "09-4": 100, "09-1": 100, 
                    "09-3": 90, "06-1": 100, "07-1": 90, "07-2": 90, "07-3": 90, "07-4": 90, 
                    "07-5": 90, "07-6": 90, "07-7": 90, "06-2": 100, "02-1": 80, "08-2": 90, 
                    "08-5": 90, "08-3": 90, "08-4": 90, "08-1": 90, "12": 100, "03-2": 100, 
                    "02-3": 80, "03-4": 100, "04-2": 100, "11": 100, "03-1": 100, "04-1": 100, 
                    "01": 90, "05-2": 90, "05-1": 100, "03-3": 100
                }
            };

            // 設定今日日期
            elements.date.textContent = new Date().toISOString().split('T')[0].replace(/-/g, '/');

            // 音效系統
            const AudioSys = {
                ctx: new (window.AudioContext || window.webkitAudioContext)(),
                play: function(freq, type, dur) {
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + dur);
                },
                beep: function() { this.play(880, 'sine', 0.1); },
                error: function() { this.play(150, 'sawtooth', 0.3); },
                success: function() {
                    this.play(523, 'triangle', 0.1);
                    setTimeout(() => this.play(659, 'triangle', 0.1), 100);
                    setTimeout(() => this.play(783, 'triangle', 0.2), 200);
                }
            };

            // ============================================
            // 2. 核心邏輯：折扣優先級計算
            // ============================================
            function calculateDiscount(item) {
                // 優先級 1 (最高): 單品永久記憶 (User Override)
                // 如果這個商品代碼在記憶庫中有紀錄，直接採用，無視規則。
                if (store.itemMemory[item.code] !== undefined) {
                    return { value: store.itemMemory[item.code], source: 'memory' };
                }

                // 優先級 2 (中等): 臨時分類規則 (Session Rule)
                // 如果這個商品的分類在規則庫中有紀錄，採用規則。
                if (item.class && store.sessionRules[item.class] !== undefined) {
                    return { value: store.sessionRules[item.class], source: 'rule' };
                }

                // 優先級 3 (最低): 系統預設值 (Default)
                // 讀取 CSV 的預設折扣或分類預設表。
                return { value: item.defaultDiscount || 100, source: 'default' };
            }

            // ============================================
            // 3. 數據讀取與商品操作
            // ============================================
            async function loadProducts() {
                try {
                    const res = await fetch('products.csv');
                    if (!res.ok) throw new Error('無法讀取 CSV');
                    const text = await res.text();
                    const lines = text.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    lines.slice(1).forEach(line => {
                        const cols = line.split(',');
                        if (cols.length < headers.length) return;
                        const p = {};
                        headers.forEach((h, i) => p[h] = cols[i]?.trim());
                        
                        if (p['CODE'] && p['CNAME']) {
                            store.products[p['CODE']] = {
                                code: p['CODE'],
                                name: p['CNAME'],
                                barcode: p['BARCODE'],
                                qty: parseInt(p['CQTY']) || 0,
                                price: parseFloat(p['PRICE']) || 0,
                                class: p['CLAS'],
                                defaultDiscount: store.defaultDiscounts[p['CLAS']] || 100
                            };
                        }
                    });
                    elements.csvStatus.textContent = `已載入 ${Object.keys(store.products).length} 筆商品資料`;
                    elements.csvStatus.style.color = '#2E8B57';
                } catch (e) {
                    console.error(e);
                    elements.csvStatus.textContent = '讀取 products.csv 失敗，請確認檔案存在';
                    elements.csvStatus.style.color = 'red';
                }
            }

            function addToCart(code, setQty = null) {
                // 嘗試直接搜尋代碼
                let prod = store.products[code];
                // 若找不到，嘗試搜尋條碼
                if (!prod) {
                    prod = Object.values(store.products).find(p => p.barcode === code);
                }

                if (!prod) {
                    AudioSys.error();
                    elements.scanFeedback.textContent = '找不到商品！';
                    elements.scanFeedback.style.color = 'red';
                    return;
                }

                const existingItem = store.cart.find(i => i.code === prod.code);
                // 每次加入時，都重新計算折扣 (為了確保吃到最新的規則或記憶)
                const discInfo = calculateDiscount(prod);

                if (existingItem) {
                    existingItem.quantity = setQty !== null ? setQty : existingItem.quantity + 1;
                    // 如果這個商品已經在記憶庫，保持記憶；否則更新為最新計算結果
                    if(existingItem.source !== 'memory') {
                        existingItem.discount = discInfo.value;
                        existingItem.source = discInfo.source;
                    }
                } else {
                    store.cart.push({
                        ...prod,
                        quantity: setQty !== null ? setQty : 1,
                        discount: discInfo.value,
                        source: discInfo.source
                    });
                }

                AudioSys.beep();
                elements.scanFeedback.textContent = `${prod.name} - ${Math.round(prod.price)}元`;
                elements.scanFeedback.style.color = '#2E8B57';
                elements.codeIn.value = '';
                
                renderCart();
                saveData();
            }

            // ============================================
            // 4. 畫面渲染 (Render) - 包含 UI 邏輯
            // ============================================
            function renderCart() {
                elements.cartBody.innerHTML = '';
                let total = 0;

                store.cart.forEach((item, index) => {
                    const subtotal = Math.round(item.price * item.quantity * (item.discount / 100));
                    total += subtotal;

                    const tr = document.createElement('tr');
                    
                    // --- 樣式邏輯 ---
                    let inputClass = '';
                    let badgeHtml = '';
                    let clearBtnHtml = '';
                    let tooltip = '預設折扣';

                    // 1. 如果是記憶模式 (紅色)
                    if (item.source === 'memory') {
                        inputClass = 'status-memory';
                        badgeHtml = '<span class="status-badge badge-mem">特價記憶</span>';
                        clearBtnHtml = `<button class="clear-mem-btn" onclick="clearItemMemory('${item.code}')" title="清除記憶，恢復原價">✕</button>`;
                        tooltip = '此商品已設定永久特價，點擊 X 可清除';
                    } 
                    // 2. 如果是規則模式 (綠色)
                    else if (item.source === 'rule') {
                        inputClass = 'status-rule';
                        badgeHtml = `<span class="status-badge badge-rule">分類${item.class}</span>`;
                        tooltip = `套用分類 ${item.class} 統一折扣`;
                    }

                    tr.innerHTML = `
                        <td>
                            <div style="font-weight:bold;">${item.name} ${badgeHtml}</div>
                            <small style="color:#888;">${item.code} | 分類: ${item.class || '無'}</small>
                        </td>
                        <td>
                            <input type="number" value="${item.price}" 
                                   onchange="updateCartItem('${item.code}', 'price', this.value)">
                        </td>
                        <td>
                            <input type="number" value="${item.quantity}" 
                                   onchange="updateCartItem('${item.code}', 'qty', this.value)">
                        </td>
                        <td>
                            <div class="discount-wrapper" title="${tooltip}">
                                <input type="number" value="${item.discount}" class="${inputClass}"
                                       onchange="updateDiscount('${item.code}', this.value)"
                                       onfocus="this.select()">
                                ${clearBtnHtml}
                                
                                <div class="sync-container">
                                    <input type="checkbox" id="sync-${index}" 
                                           onchange="toggleSyncRule('${item.class}', this.checked, ${item.discount})">
                                    <label for="sync-${index}" style="cursor:pointer;">同步分類 ${item.class || ''}</label>
                                </div>
                            </div>
                        </td>
                        <td style="font-weight:bold; color:#555;">${subtotal}</td>
                    `;
                    elements.cartBody.appendChild(tr);
                });

                elements.totalDisplay.textContent = total;
                updateChange();
            }

            // --- 全局函數：供 HTML onclick 調用 ---
            
            // 1. 更新一般資訊 (數量/單價)
            window.updateCartItem = (code, field, val) => {
                const item = store.cart.find(i => i.code === code);
                if (!item) return;
                
                if (field === 'qty') item.quantity = parseInt(val);
                if (field === 'price') item.price = parseFloat(val);
                
                if (item.quantity <= 0) {
                    store.cart = store.cart.filter(i => i.code !== code);
                }
                renderCart(); saveData();
            };

            // 2. [核心] 更新折扣 (觸發記憶)
            window.updateDiscount = (code, val) => {
                const newDiscount = parseFloat(val);
                if (isNaN(newDiscount)) return;

                const item = store.cart.find(i => i.code === code);
                if (item) {
                    // 只要手動改了，就視為「永久記憶」
                    store.itemMemory[code] = newDiscount;
                    localStorage.setItem('itemMemory', JSON.stringify(store.itemMemory));

                    item.discount = newDiscount;
                    item.source = 'memory';
                    renderCart(); saveData();
                }
            };

            // 3. [核心] 清除單品記憶
            window.clearItemMemory = (code) => {
                delete store.itemMemory[code];
                localStorage.setItem('itemMemory', JSON.stringify(store.itemMemory));
                
                // 重新計算折扣 (回退到規則或預設)
                const item = store.cart.find(i => i.code === code);
                if (item) {
                    const info = calculateDiscount(store.products[code]);
                    item.discount = info.value;
                    item.source = info.source;
                }
                renderCart(); saveData();
            };

            // 4. [核心] 切換分類同步規則
            window.toggleSyncRule = (classId, isChecked, discountVal) => {
                if (!classId || classId === 'undefined') {
                    alert('此商品無分類，無法使用同步功能');
                    return;
                }

                if (isChecked) {
                    // 設定全區規則
                    store.sessionRules[classId] = parseFloat(discountVal);
                    
                    // 強制更新購物車內同分類商品
                    // 策略：當設定同步時，清除個別記憶，讓大家統一 (避免衝突)
                    store.cart.forEach(i => {
                        if (i.class === classId) {
                            delete store.itemMemory[i.code]; // 清除個別記憶
                            i.discount = parseFloat(discountVal);
                            i.source = 'rule';
                        }
                    });
                } else {
                    // 取消規則
                    delete store.sessionRules[classId];
                    // 重新計算所有該分類商品
                    store.cart.forEach(i => {
                        if (i.class === classId) {
                            const info = calculateDiscount(store.products[i.code]);
                            i.discount = info.value;
                            i.source = info.source;
                        }
                    });
                }
                
                localStorage.setItem('sessionRules', JSON.stringify(store.sessionRules));
                localStorage.setItem('itemMemory', JSON.stringify(store.itemMemory));
                renderCart(); saveData();
            };

            function updateChange() {
                const total = parseInt(elements.totalDisplay.textContent);
                const paid = parseInt(elements.paidIn.value) || 0;
                elements.changeDisplay.textContent = paid - total;
            }

            // ============================================
            // 5. 結帳流程
            // ============================================
            function checkout(method) {
                if (store.cart.length === 0) {
                    AudioSys.error();
                    alert('購物車是空的，無法結帳');
                    return;
                }

                // 文化幣混合支付邏輯
                if (method === '文化幣') {
                    const total = parseInt(elements.totalDisplay.textContent);
                    const coinInput = prompt(`訂單總額 ${total} 元。\n請輸入文化幣支付金額：`, total);
                    if (coinInput === null) return;
                    
                    const coinVal = parseInt(coinInput);
                    if (isNaN(coinVal) || coinVal < 0) return alert('金額輸入錯誤');
                    
                    if (coinVal > total) return alert('文化幣金額不可大於總額');

                    const cashRemain = total - coinVal;
                    if (cashRemain > 0) {
                        method = `文化幣(${coinVal})+現金(${cashRemain})`;
                    } else {
                        method = `文化幣(${coinVal})`;
                    }
                }

                AudioSys.success();

                // 建立訂單
                const dateObj = new Date();
                const orderId = `${dateObj.getFullYear()}${String(dateObj.getMonth()+1).padStart(2,'0')}${String(dateObj.getDate()).padStart(2,'0')}-${String(store.counter).padStart(3,'0')}`;
                
                store.clients[orderId] = {
                    id: orderId,
                    amount: parseFloat(elements.totalDisplay.textContent),
                    method: method,
                    items: JSON.parse(JSON.stringify(store.cart)), // 深拷貝防止修改
                    time: dateObj.toLocaleString()
                };

                // 更新商品銷售統計
                store.cart.forEach(item => {
                    if (!store.summary[item.code]) {
                        store.summary[item.code] = { 
                            code: item.code, 
                            name: item.name, 
                            qty: 0, 
                            rev: 0 
                        };
                    }
                    const itemTotal = Math.round(item.price * item.quantity * (item.discount / 100));
                    store.summary[item.code].qty += item.quantity;
                    store.summary[item.code].rev += itemTotal;
                });

                // 重置狀態
                store.cart = [];
                store.counter++;
                elements.codeIn.value = '';
                elements.paidIn.value = 1000;
                
                // 動畫效果
                const btnMap = { '信用卡': 'btn-card', 'LINE Pay': 'btn-line', '現金': 'btn-cash' };
                const btnId = method.includes('文化') ? 'btn-coin' : btnMap[method];
                if (btnId) {
                    const btn = document.getElementById(btnId);
                    btn.classList.add('pulse-anim');
                    setTimeout(() => btn.classList.remove('pulse-anim'), 300);
                }

                saveData();
                renderCart();
                renderStats();
            }

            // ============================================
            // 6. 統計報表
            // ============================================
            function renderStats() {
                // 1. 訂單列表 (最新的在最上面)
                elements.orderBody.innerHTML = '';
                const orders = Object.values(store.clients).reverse();
                
                // 只顯示最近 50 筆以避免 DOM 過重
                orders.slice(0, 50).forEach(o => {
                    elements.orderBody.innerHTML += `
                        <tr>
                            <td><small>${o.id}</small></td>
                            <td>${Math.round(o.amount)}</td>
                            <td>${o.method}</td>
                            <td>
                                <button onclick="deleteOrder('${o.id}')" style="background:#d9534f; color:white; border:none; border-radius:3px; cursor:pointer;">刪</button>
                            </td>
                        </tr>
                    `;
                });

                // 2. 商品銷售列表 (依營收排序)
                elements.itemStatsBody.innerHTML = '';
                let totalRevenue = 0;
                const items = Object.values(store.summary).sort((a, b) => b.rev - a.rev);
                
                items.forEach(i => {
                    totalRevenue += i.rev;
                    elements.itemStatsBody.innerHTML += `
                        <tr>
                            <td>${i.code}</td>
                            <td>${i.name}</td>
                            <td>${i.qty}</td>
                            <td>${i.rev}</td>
                        </tr>
                    `;
                });

                // 3. 數值統計
                elements.revenueDisplay.textContent = totalRevenue;
                elements.orderCount.textContent = orders.length;
                elements.avgOrder.textContent = orders.length ? Math.round(totalRevenue / orders.length) : 0;

                // 4. 支付方式分析
                let payStats = { cash: 0, card: 0, line: 0, coin: 0 };
                orders.forEach(o => {
                    if (o.method.includes('信用卡')) payStats.card += o.amount;
                    else if (o.method.includes('LINE')) payStats.line += o.amount;
                    else if (o.method.includes('文化')) {
                        // 解析 "文化幣(500)+現金(200)"
                        const coinMatch = o.method.match(/文化幣\((\d+)\)/);
                        const coinVal = coinMatch ? parseInt(coinMatch[1]) : o.amount;
                        payStats.coin += coinVal;
                        payStats.cash += (o.amount - coinVal);
                    } else {
                        payStats.cash += o.amount;
                    }
                });

                elements.paymentStats.innerHTML = `
                    <span style="margin-right:10px;">現金: <b>${payStats.cash}</b></span>
                    <span style="margin-right:10px;">刷卡: <b>${payStats.card}</b></span>
                    <span style="margin-right:10px;">LINE: <b>${payStats.line}</b></span>
                    <span>文化幣: <b>${payStats.coin}</b></span>
                `;
            }

            window.deleteOrder = (id) => {
                if (!confirm('確定要刪除這筆訂單嗎？')) return;
                
                const order = store.clients[id];
                // 扣除統計
                order.items.forEach(item => {
                    if (store.summary[item.code]) {
                        store.summary[item.code].qty -= item.quantity;
                        store.summary[item.code].rev -= Math.round(item.price * item.quantity * (item.discount/100));
                        if(store.summary[item.code].qty <= 0) delete store.summary[item.code];
                    }
                });

                delete store.clients[id];
                saveData(); renderStats();
            };

            // ============================================
            // 7. 資料管理 (備份/還原/匯出)
            // ============================================
            function saveData() {
                localStorage.setItem('cart', JSON.stringify(store.cart));
                localStorage.setItem('clients', JSON.stringify(store.clients));
                localStorage.setItem('summary', JSON.stringify(store.summary));
                localStorage.setItem('counter', JSON.stringify(store.counter));
            }

            // 匯出 CSV (Excel 可讀格式)
            elements.btns.export.addEventListener('click', () => {
                let csv = "\uFEFF"; // BOM for Excel
                
                // 區塊1: 概況
                csv += `匯出時間,${new Date().toLocaleString()}\n`;
                csv += `總營收,${elements.revenueDisplay.textContent}\n\n`;

                // 區塊2: 訂單明細
                csv += "--- 訂單明細 ---\n";
                csv += "訂單編號,總金額,支付方式,時間,商品代碼,商品名稱,數量,單價,折扣%,小計\n";
                
                Object.values(store.clients).forEach(o => {
                    o.items.forEach(i => {
                        csv += `"${o.id}",${o.amount},"${o.method}",${o.time},"${i.code}","${i.name}",${i.quantity},${i.price},${i.discount},${Math.round(i.price * i.quantity * i.discount / 100)}\n`;
                    });
                });

                // 區塊3: 商品統計
                csv += "\n--- 商品銷售統計 ---\n";
                csv += "商品代碼,商品名稱,總銷量,總銷售額\n";
                Object.values(store.summary).forEach(s => {
                    csv += `"${s.code}","${s.name}",${s.qty},${s.rev}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `POS_Report_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            });

            // 備份
            elements.btns.backup.addEventListener('click', () => {
                const dataStr = JSON.stringify(store);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `POS_Backup_${new Date().toISOString().slice(0,10)}.json`;
                link.click();
            });

            // 還原
            elements.btns.restore.addEventListener('click', () => elements.importFile.click());
            elements.importFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        // 合併資料
                        store = { ...store, ...data };
                        // 重新寫入記憶體
                        localStorage.setItem('itemMemory', JSON.stringify(store.itemMemory));
                        localStorage.setItem('sessionRules', JSON.stringify(store.sessionRules));
                        saveData();
                        alert('資料還原成功，頁面將重新整理');
                        location.reload();
                    } catch (err) { alert('備份檔案格式錯誤'); }
                };
                reader.readAsText(file);
            });

            // 清除記憶
            elements.btns.resetMem.addEventListener('click', () => {
                if (confirm('確定要清除所有「單品特價記憶」嗎？\n所有商品將恢復為分類規則或預設價格。')) {
                    store.itemMemory = {};
                    localStorage.setItem('itemMemory', JSON.stringify(store.itemMemory));
                    
                    // 刷新購物車
                    store.cart.forEach(i => {
                         const info = calculateDiscount(store.products[i.code]);
                         i.discount = info.val;
                         i.source = info.source;
                    });
                    renderCart(); saveData();
                    alert('記憶已清除');
                }
            });

            // 系統重置
            elements.btns.clearAll.addEventListener('click', () => {
                if (confirm('危險操作：這將清空所有訂單與營業額紀錄！確定嗎？')) {
                    if (prompt('請輸入 "DELETE" 以確認清空') === 'DELETE') {
                        localStorage.clear();
                        location.reload();
                    }
                }
            });

            // ============================================
            // 8. 事件監聽 (Inputs & Shortcuts)
            // ============================================
            
            // 掃描框
            elements.codeIn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const val = e.target.value.trim().toUpperCase();
                    if (!val) return;
                    
                    // 支援 "5*CODE" 格式
                    if (val.includes('*')) {
                        const parts = val.split('*');
                        addToCart(parts[1], parseInt(parts[0]));
                    } else {
                        addToCart(val);
                    }
                }
            });

            // 關鍵字搜尋
            elements.searchIn.addEventListener('input', (e) => {
                const key = e.target.value.trim().toUpperCase();
                elements.searchResults.innerHTML = '';
                elements.searchResults.style.display = 'none';
                
                if (!key) return;

                const matches = Object.values(store.products).filter(p => 
                    p.code.includes(key) || p.name.includes(key) || (p.barcode && p.barcode.includes(key))
                ).slice(0, 10);

                if (matches.length > 0) {
                    elements.searchResults.style.display = 'block';
                    matches.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'search-item';
                        div.innerHTML = `<span>${p.name}</span> <span style="color:#888;">${p.code}</span>`;
                        div.onclick = () => {
                            addToCart(p.code);
                            elements.searchIn.value = '';
                            elements.searchResults.style.display = 'none';
                        };
                        elements.searchResults.appendChild(div);
                    });
                }
            });

            // 找零計算
            elements.paidIn.addEventListener('input', updateChange);

            // 結帳按鈕點擊
            elements.btns.card.addEventListener('click', () => checkout('信用卡'));
            elements.btns.line.addEventListener('click', () => checkout('LINE Pay'));
            elements.btns.coin.addEventListener('click', () => checkout('文化幣'));
            elements.btns.cash.addEventListener('click', () => checkout('現金'));

            // 鍵盤快捷鍵
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F7') { e.preventDefault(); checkout('信用卡'); }
                if (e.key === 'F8') { e.preventDefault(); checkout('LINE Pay'); }
                if (e.key === 'F9') { e.preventDefault(); checkout('文化幣'); }
                if (e.key === 'F10') { e.preventDefault(); checkout('現金'); }
            });

            // 點擊空白處關閉搜尋結果
            document.addEventListener('click', (e) => {
                if (e.target !== elements.searchIn) {
                    elements.searchResults.style.display = 'none';
                }
            });

            // ============================================
            // 9. 啟動程序
            // ============================================
            loadProducts().then(() => {
                renderCart();
                renderStats();
            });
        });
    </script>
</body>
</html>
