<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>腓利門雲POS</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            background-color: #F5F5DC;
            padding-bottom: 50px; /* 預留底部空間 */
        }

        /* 父級容器 */
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
            margin-top: 20px;
        }

        .container-half {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 48%;
            margin-bottom: 20px;
            min-height: 300px;
            box-sizing: border-box;
            position: relative;
        }

        /* 全寬容器用於記帳模式 */
        .container-full {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 100%;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .header, .form-group, .table-container, .payment-info, .notes-container, .accounting-container {
            border: 1px solid #D2B48C;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header button, .form-group button, .btn-group button, .acct-btn {
            background-color: #8A6739;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        /* 特別標示危險操作 */
        #clear-all-btn { background-color: #a94442; }

        .form-group input, .notes-container textarea {
            width: calc(100% - 20px);
            padding: 10px;
            font-size: 1em;
            border: 1px solid #D2B48C;
            border-radius: 4px;
            background-color: #E6E2B2;
        }

        .notes-container textarea {
            resize: none;
            background-color: #E6E2B2;
            height: 100px;
        }

        .total {
            font-size: 1.5em;
            font-weight: bold;
            color: #F5F5DC;
            background-color: #8A6739;
            padding: 10px;
            border-radius: 8px 8px 0 0;
            text-align: right;
        }

        .payment-info {
            background-color: #FFFFFF;
            border-radius: 0 0 8px 8px;
            border-top: 2px solid #8A6739;
            padding: 15px;
            display: flex;
            flex-direction: column; 
            gap: 15px;
        }

        .payment-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .payment-info > span, .payment-details > span {
            color: #8B4513;
            font-weight: bold;
        }

        .payment-info input#paid-amount {
            max-width: 100px;
            padding: 5px;
            font-size: 1.2em;
            text-align: right;
        }

        /* 底部四個結帳按鈕的樣式 */
        .checkout-buttons-area {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }

        .checkout-btn {
            flex: 1; 
            background-color: #8A6739;
            border: none;
            border-radius: 5px;
            padding: 12px 10px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding-left: 15px;
        }

        .checkout-btn:hover {
            background-color: #6d522d;
            transform: translateY(-2px);
        }

        .checkout-btn:active { transform: translateY(0); }

        .checkout-btn .btn-key {
            font-size: 2.2em !important;
            font-weight: 800 !important;
            color: #FFF8DC !important;
            margin-bottom: 5px;
            display: block;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            line-height: 1;
        }

        .checkout-btn .btn-label {
            font-size: 0.9em !important;
            color: #F5F5DC !important;
            display: block;
            font-weight: normal;
        }

        /* 30秒提醒動畫 */
        .btn-alert {
            animation: heartBeat 1s infinite;
            background-color: #ff8c00 !important; /* 深橘色提醒 */
            transform: scale(1.1);
            z-index: 10;
        }

        @keyframes heartBeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .table-container { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 5px;
            text-align: left;
            border-bottom: 1px solid #D2B48C;
            vertical-align: middle;
        }

        th {
            font-size: 0.9em;
            color: #8B4513;
        }

        td { font-size: 0.8em; }

        .bottom-total {
            border-radius: 8px;
            margin-top: 10px; /* 調整間距 */
        }

        td input[type="number"] {
            width: 50px;
            padding: 5px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        
        .stats-info {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed #D2B48C;
            line-height: 1.6;
        }
        
        .stat-item {
            display: inline-block;
            margin-right: 15px;
        }
        
        .stat-item b { color: #8A6739; }

        @media (max-width: 768px) {
            .flex-container {
                flex-direction: column;
                align-items: center;
                padding: 0 10px;
            }
            .container-half, .container-full {
                width: 100%;
                margin-bottom: 20px;
            }
            .checkout-buttons-area { flex-wrap: wrap; }
            .checkout-btn { min-width: 45%; }
        }

        .animate-click { animation: pulse-green 0.5s ease-out; }

        @keyframes pulse-green {
            0% { transform: scale(1); background-color: #8A6739; }
            50% { transform: scale(1.05); background-color: #28a745; }
            100% { transform: scale(1); background-color: #8A6739; }
        }

        .discount-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .sync-option {
            display: none;
            margin-top: 4px;
            font-size: 0.75em;
            color: #8B4513;
            background-color: #fff8dc;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #D2B48C;
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 10;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        .discount-wrapper:focus-within .sync-option {
            display: flex;
            align-items: center;
        }

        .manual-locked {
            border: 2px solid #a94442 !important; 
            background-color: #fff0f0 !important;
        }
        
        .class-rule-active {
            border: 2px solid #28a745 !important;
            background-color: #f0fff0 !important;
        }

        /* --- 記帳模式樣式 --- */
        .accounting-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .money-input-group {
            display: flex;
            flex-direction: column;
            background-color: #FFF8DC;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #D2B48C;
        }

        .money-input-group label {
            font-size: 0.9em;
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 5px;
        }

        .money-input-group input {
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ccc;
            padding: 5px;
            text-align: right;
        }

        .acct-summary {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            border: 2px solid #8A6739;
        }

        .acct-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .acct-row.highlight {
            border-top: 1px solid #ccc;
            padding-top: 8px;
            font-weight: bold;
            color: #a94442;
        }

        /* 修改單付款方式按鈕樣式 */
        .btn-change-pay {
            background-color: #fff;
            border: 1px solid #8A6739;
            color: #8A6739;
            padding: 2px 6px;
            font-size: 0.8em;
            cursor: pointer;
            border-radius: 3px;
        }
        .btn-change-pay:hover {
            background-color: #8A6739;
            color: white;
        }

        /* 作廢樣式 */
        .void-order {
            text-decoration: line-through;
            color: #999 !important;
            background-color: #f0f0f0;
        }
        .void-order span, .void-order a, .void-order button {
            opacity: 0.6;
        }
        
        .btn-action-group button {
            margin-left: 2px;
            padding: 2px 5px;
            font-size: 0.8em;
        }
        
        .btn-void { background-color: #666; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .btn-del { background-color: #a94442; color: white; border: none; border-radius: 3px; cursor: pointer; }

    </style>
</head>
<body>
    <input type="file" id="import-file" accept=".json" style="display: none;">

    <div class="flex-container">
        <div class="container-half">
            <div class="header">
                <div>
                    <img src="image/logo.png" alt="腓利門Logo" style="height: 40px; vertical-align: middle; margin-right: 10px;">
                    <span id="title">腓利門雲POS</span>
                </div>
            </div>
            <div class="header" style="justify-content: flex-end;">
                <span id="current-date" style="margin-right: auto;"></span>
                <div class="btn-group">
                    <button id="backup-btn" style="background-color: #4682B4;">備份資料</button>
                    <button id="restore-btn" style="background-color: #20B2AA;">還原資料</button>
                    <button id="export-csv-btn">匯出 CSV</button>
                    <button id="clear-all-btn">刪除全部</button>
                </div>
            </div>
            <div class="form-group">
                <label for="product-code">請輸入商品代碼/條碼：</label>
                <input type="text" id="product-code" placeholder="請輸入商品代碼/條碼">
                <div id="product-info"></div>
            </div>
            <div class="form-group search-container">
                <label for="keyword-search">輸入關鍵字搜尋商品：</label>
                <input type="text" id="keyword-search" placeholder="名稱 / 代碼 / 條碼 皆可搜尋">
                <div id="search-results" class="search-results"></div>
            </div>
            <div id="csv-validation"></div>
        </div>

        <div class="container-half">
            <div class="table-container">
                <div class="table-title">結帳明細</div>
                <table id="cart-table">
                    <thead>
                        <tr>
                            <th>名稱</th>
                            <th>單價</th>
                            <th>數量</th>
                            <th style="min-width: 100px;">折扣 %</th>
                            <th>小計</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="total">應付金額：<span id="total-amount">0</span> 元</div>
            
            <div class="payment-info">
                <div class="payment-details">
                    <span>實付金額：<input type="number" id="paid-amount" value="1000" placeholder="輸入實付金額"></span>
                    <span>找錢：<span id="change-amount">0</span> 元</span>
                </div>
                
                <div class="checkout-buttons-area">
                    <button id="btn-f7" class="checkout-btn">
                        <span class="btn-key">F7</span>
                        <span class="btn-label">信用卡結帳</span>
                    </button>
                    <button id="btn-f8" class="checkout-btn">
                        <span class="btn-key">F8</span>
                        <span class="btn-label">LINE PAY</span>
                    </button>
                    <button id="btn-f9" class="checkout-btn">
                        <span class="btn-key">F9</span>
                        <span class="btn-label">文化幣</span>
                    </button>
                    <button id="btn-f10" class="checkout-btn">
                        <span class="btn-key">F10</span>
                        <span class="btn-label">現金結帳</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-container">
        <div class="container-half">
            <div class="table-title">
                單筆消費明細 (作廢/刪除/修改付款) <br>
                統計訂單總數: <span id="total-orders">0</span> | 平均消費: <span id="average-amount">0</span> 元
                <div id="payment-stats" class="stats-info">
                </div>
            </div>
            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table id="summary-table">
                    <thead>
                        <tr>
                            <th>客戶名稱</th>
                            <th>消費金額</th>
                            <th>付款方式</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="notes-container">
                <label for="notes">訂單備註：</label>
                <textarea id="notes"></textarea>
            </div>
        </div>

        <div class="container-half">
            <div class="table-title">
                消費總覽
            </div>
            <div class="table-container" style="max-height: 350px; overflow-y: auto;">
                <table id="overall-summary-table">
                    <thead>
                        <tr>
                            <th>商品代碼</th>
                            <th>產品名稱</th>
                            <th>數量小計</th>
                            <th>金額小計</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="total bottom-total">營收總金額：<span id="overall-total-amount">0</span> 元</div>
        </div>
    </div>

    <div class="flex-container">
        <div class="container-full">
            <div class="header">
                <b>記帳模式 (現金盤點)</b>
                <button onclick="clearAccountingInputs()">清空盤點數據</button>
            </div>
            <div class="accounting-container">
                <div class="accounting-grid">
                    <div class="money-input-group">
                        <label>1000 元</label>
                        <input type="number" class="money-count" data-val="1000" min="0" placeholder="張數">
                    </div>
                    <div class="money-input-group">
                        <label>500 元</label>
                        <input type="number" class="money-count" data-val="500" min="0" placeholder="張數">
                    </div>
                    <div class="money-input-group">
                        <label>100 元</label>
                        <input type="number" class="money-count" data-val="100" min="0" placeholder="張數">
                    </div>
                    <div class="money-input-group">
                        <label>50 元</label>
                        <input type="number" class="money-count" data-val="50" min="0" placeholder="個數">
                    </div>
                    <div class="money-input-group">
                        <label>10 元</label>
                        <input type="number" class="money-count" data-val="10" min="0" placeholder="個數">
                    </div>
                    <div class="money-input-group">
                        <label>5 元</label>
                        <input type="number" class="money-count" data-val="5" min="0" placeholder="個數">
                    </div>
                    <div class="money-input-group">
                        <label>1 元</label>
                        <input type="number" class="money-count" data-val="1" min="0" placeholder="個數">
                    </div>
                    <div class="money-input-group" style="background-color: #e0f7fa;">
                        <label>初始備用金</label>
                        <input type="number" id="initial-cash" value="11000" min="0">
                    </div>
                    <div class="money-input-group" style="background-color: #ffebee;">
                        <label>支出(加油/餐費)</label>
                        <input type="number" id="expenses-cash" value="0" min="0">
                    </div>
                </div>
                
                <div class="acct-summary">
                    <div class="acct-row">
                        <span>盤點現金總額 (張數x幣值)：</span>
                        <span id="calc-drawer-total">0</span>
                    </div>
                    <div class="acct-row">
                        <span>(-) 初始備用金：</span>
                        <span id="calc-initial">0</span>
                    </div>
                     <div class="acct-row">
                        <span>(+) 支出費用憑證：</span>
                        <span id="calc-expenses">0</span>
                    </div>
                    <hr>
                    <div class="acct-row highlight">
                        <span>= 實際營業額 (現金)：</span>
                        <span id="calc-net-cash">0</span>
                    </div>
                    <div class="acct-row" style="color: #555; font-size: 0.9em;">
                        <span>(系統記錄現金營收：<span id="sys-cash-total">0</span>)</span>
                    </div>
                    <div class="acct-row" id="cash-diff-row" style="font-weight: bold; margin-top: 5px;">
                        <span>差異：</span>
                        <span id="cash-diff">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM 元素獲取 ---
            const currentDateElement = document.getElementById('current-date');
            const keywordSearchInput = document.getElementById('keyword-search');
            const searchResultsElement = document.getElementById('search-results');
            const productCodeInput = document.getElementById('product-code');
            const paidAmountInput = document.getElementById('paid-amount');
            const productInfoElement = document.getElementById('product-info');
            const csvValidationElement = document.getElementById('csv-validation');
            const cartTableBody = document.querySelector('#cart-table tbody');
            const totalAmountElement = document.getElementById('total-amount');
            const changeAmountElement = document.getElementById('change-amount');
            const summaryTableBody = document.querySelector('#summary-table tbody');
            const overallSummaryTableBody = document.querySelector('#overall-summary-table tbody');
            const overallTotalAmountElement = document.getElementById('overall-total-amount');
            
            // 按鈕們
            const btnF7 = document.getElementById('btn-f7');
            const btnF8 = document.getElementById('btn-f8');
            const btnF9 = document.getElementById('btn-f9');
            const btnF10 = document.getElementById('btn-f10');
            const checkoutBtns = [btnF7, btnF8, btnF9, btnF10];
            
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const backupBtn = document.getElementById('backup-btn');
            const restoreBtn = document.getElementById('restore-btn');
            const importFileInput = document.getElementById('import-file');

            const totalOrdersElement = document.getElementById('total-orders');
            const averageAmountElement = document.getElementById('average-amount');
            const paymentStatsElement = document.getElementById('payment-stats');
            const notesElement = document.getElementById('notes');

            // 記帳模式元素
            const moneyInputs = document.querySelectorAll('.money-count');
            const initialCashInput = document.getElementById('initial-cash');
            const expensesCashInput = document.getElementById('expenses-cash');
            const calcDrawerTotalEl = document.getElementById('calc-drawer-total');
            const calcInitialEl = document.getElementById('calc-initial');
            const calcExpensesEl = document.getElementById('calc-expenses');
            const calcNetCashEl = document.getElementById('calc-net-cash');
            const sysCashTotalEl = document.getElementById('sys-cash-total');
            const cashDiffRow = document.getElementById('cash-diff-row');
            const cashDiffEl = document.getElementById('cash-diff');

            // --- 狀態變數 ---
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            let products = {}; 
            let discountRates = {}; 
            let clients = JSON.parse(localStorage.getItem('clients')) || {};
            let overallSummary = JSON.parse(localStorage.getItem('overallSummary')) || {};
            let clientCounter = JSON.parse(localStorage.getItem('clientCounter')) || 1;
            let hasShownEmptyCartAlert = false;
            let sessionRules = JSON.parse(localStorage.getItem('sessionRules')) || {};

            // [NEW] 單品價格記憶 (Session Price Overrides)
            // 當用戶手動改價後，該商品代碼的價格會被記錄，下次加入時優先使用
            let priceOverrides = JSON.parse(localStorage.getItem('priceOverrides')) || {};

            // [NEW] 閒置計時器變數
            let idleTimer = null;
            const IDLE_TIMEOUT_MS = 30000; // 30秒

            // --- 音效控制器 ---
            const POSAudio = {
                ctx: new (window.AudioContext || window.webkitAudioContext)(),
                playTone: function(freq, type, duration, startTime = 0) {
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime + startTime);
                    gain.gain.setValueAtTime(0.1, this.ctx.currentTime + startTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + startTime + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(this.ctx.currentTime + startTime);
                    osc.stop(this.ctx.currentTime + startTime + duration);
                },
                beep: function() { this.playTone(880, 'sine', 0.1); },
                error: function() { this.playTone(150, 'sawtooth', 0.3); },
                success: function() {
                    this.playTone(523.25, 'triangle', 0.1, 0);
                    this.playTone(659.25, 'triangle', 0.1, 0.05);
                    this.playTone(783.99, 'triangle', 0.2, 0.1);
                }
            };

            // --- 日期與初始化 ---
            const currentDate = new Date().toISOString().split('T')[0].replace(/-/g, '/');
            currentDateElement.textContent = `今日日期：${currentDate}`;
            notesElement.value = localStorage.getItem('notes') || '';
            notesElement.addEventListener('input', () => {
                localStorage.setItem('notes', notesElement.value);
            });

            // 記帳輸入框初始化
            initialCashInput.value = localStorage.getItem('acctInitial') || '11000';
            expensesCashInput.value = localStorage.getItem('acctExpenses') || '0';
            moneyInputs.forEach(input => {
                const saved = localStorage.getItem(`acctMoney_${input.dataset.val}`);
                if(saved) input.value = saved;
            });

            const generateClientId = () => {
                const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}${month}${day}-${String(clientCounter).padStart(3, '0')}`;
            };

            const loadDiscountRates = () => {
                discountRates = {
                    "POS": 100, "02-2": 100, "09-2": 90, "09-5": 100, "09-4": 100, "09-1": 100, 
                    "09-3": 90, "06-1": 100, "07-1": 90, "07-2": 90, "07-3": 90, "07-4": 90, 
                    "07-5": 90, "07-6": 90, "07-7": 90, "06-2": 100, "02-1": 80, "08-2": 90, 
                    "08-5": 90, "08-3": 90, "08-4": 90, "08-1": 90, "12": 100, "03-2": 100, 
                    "02-3": 80, "03-4": 100, "04-2": 100, "11": 100, "03-1": 100, "04-1": 100, 
                    "01": 90, "05-2": 90, "05-1": 100, "03-3": 100
                };
            };

            const loadProducts = async () => {
                if (!csvValidationElement) return;
                try {
                    const response = await fetch('products.csv');
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    
                    const data = await response.text();
                    const lines = data.split('\n');
                    let headers = [];
                    let isHeader = true;

                    lines.forEach(line => {
                        const columns = line.split(',');
                        if (isHeader) {
                            headers = columns.map(header => header.trim());
                            isHeader = false;
                            return;
                        }
                        const product = {};
                        headers.forEach((header, index) => {
                            product[header] = columns[index]?.trim();
                        });

                        if (product['CODE'] && product['CNAME'] && product['BARCODE'] && !isNaN(parseInt(product['CQTY']))) {
                            const defaultDiscount = discountRates[product['CLAS']] || 100;
                            products[product['CODE']] = {
                                code: product['CODE'],
                                name: product['CNAME'],
                                barcode: product['BARCODE'],
                                qty: parseInt(product['CQTY']),
                                price: parseFloat(product['PRICE']) || 0,
                                class: product['CLAS'], 
                                defaultDiscount: defaultDiscount
                            };
                        }
                    });
                    csvValidationElement.textContent = "CSV檔讀取成功";
                } catch (error) {
                    console.error('Error loading CSV file:', error);
                    csvValidationElement.textContent = `CSV文件讀取失敗: ${error.message}`;
                }
            };

            // --- 核心折扣與價格邏輯 ---
            const calculateItemDiscount = (item) => {
                if (item.isManual) return item.discount;
                if (item.class && sessionRules[item.class] !== undefined) return sessionRules[item.class];
                return item.defaultDiscount || 100;
            };

            // --- 購物車與 UI ---
            const addProductToCart = (code) => {
                // 重置閒置計時器
                resetIdleTimer();

                const product = products[code];
                const existingItem = cart.find(item => item.code === code);
                
                if (existingItem) {
                    existingItem.quantity += 1;
                    if (!existingItem.isManual) {
                        existingItem.discount = calculateItemDiscount(existingItem);
                    }
                    // [NEW] 檢查是否有價格覆寫，若有則強制應用
                    if (priceOverrides[code] !== undefined) {
                        existingItem.price = priceOverrides[code];
                    }
                } else {
                    const newItem = { 
                        ...product, 
                        quantity: 1,
                        isManual: false,
                        discount: 0 
                    };
                    // [NEW] 應用已記憶的價格
                    if (priceOverrides[code] !== undefined) {
                        newItem.price = priceOverrides[code];
                    }

                    newItem.discount = calculateItemDiscount(newItem);
                    cart.push(newItem);
                }
                
                POSAudio.beep();
                updateCartDisplay();
                calculateTotal();
                saveCart();
                productCodeInput.value = ''; 
            };

            // [NEW] 閒置計時器邏輯
            const resetIdleTimer = () => {
                if (idleTimer) clearTimeout(idleTimer);
                checkoutBtns.forEach(btn => btn.classList.remove('btn-alert'));
                
                if (cart.length > 0) {
                    idleTimer = setTimeout(() => {
                        checkoutBtns.forEach(btn => btn.classList.add('btn-alert'));
                    }, IDLE_TIMEOUT_MS);
                }
            };

            const updateCartDisplay = () => {
                cartTableBody.innerHTML = '';
                cart.forEach(item => {
                    const row = document.createElement('tr');
                    let inputClass = 'discount-input';
                    let statusTitle = "預設折扣";
                    if (item.isManual) {
                        inputClass += ' manual-locked';
                        statusTitle = "單品已鎖定";
                    } else if (sessionRules[item.class]) {
                        inputClass += ' class-rule-active';
                        statusTitle = `套用分類規則 (${item.class})`;
                    }

                    // 檢查價格是否被覆寫，標示樣式
                    const priceStyle = priceOverrides[item.code] !== undefined ? 'border: 2px solid #8A6739; background-color:#fff8dc;' : '';

                    row.innerHTML = `
                        <td>${item.name} <br><small style="color:#888;">${item.class || '無分類'}</small></td>
                        <td><input type="number" name="price-${item.code}" value="${item.price}" step="0.1" min="0" style="width: 60px; ${priceStyle}" class="price-input" data-code="${item.code}"></td>
                        <td><input type="number" name="quantity-${item.code}" value="${item.quantity}" min="-1000" class="quantity-input" data-code="${item.code}"></td>
                        <td>
                            <div class="discount-wrapper" title="${statusTitle}">
                                <input type="number" value="${item.discount}" step="0.1" min="0" max="100" class="${inputClass}" data-code="${item.code}">
                                <label class="sync-option">
                                    <input type="checkbox" class="sync-check" data-class="${item.class}" data-code="${item.code}">
                                    同步修改 [${item.class || '無'}]
                                </label>
                            </div>
                        </td>
                        <td>${Math.round(item.price * item.quantity * (item.discount / 100))}</td>
                    `;
                    cartTableBody.appendChild(row);
                });

                attachCartEventListeners();
                resetIdleTimer(); // 每次刷新都重置
            };

            const attachCartEventListeners = () => {
                const debounce = (func, delay) => {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), delay);
                    };
                };

                // 數量監聽
                document.querySelectorAll('.quantity-input').forEach(input => {
                    input.addEventListener('input', debounce((e) => {
                        resetIdleTimer();
                        const code = e.target.dataset.code;
                        const newQuantity = parseInt(e.target.value);
                        if (!isNaN(newQuantity)) {
                            const item = cart.find(item => item.code === code);
                            if (item) {
                                item.quantity = newQuantity;
                                calculateTotal();
                                updateCartDisplay();
                                saveCart();
                            }
                        }
                    }, 500));
                });

                // 單價監聽 [NEW] 增加價格記憶邏輯
                document.querySelectorAll('.price-input').forEach(input => {
                    input.addEventListener('input', debounce((e) => {
                        resetIdleTimer();
                        const code = e.target.dataset.code;
                        const newPrice = parseFloat(e.target.value);
                        if (!isNaN(newPrice) && newPrice >= 0) {
                            const item = cart.find(item => item.code === code);
                            if (item) {
                                item.price = newPrice;
                                // [NEW] 記錄價格到覆寫表
                                priceOverrides[code] = newPrice;
                                localStorage.setItem('priceOverrides', JSON.stringify(priceOverrides));
                                
                                calculateTotal();
                                updateCartDisplay();
                                saveCart();
                            }
                        }
                    }, 500));
                });

                // 折扣監聽
                document.querySelectorAll('.discount-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        resetIdleTimer();
                        const code = e.target.dataset.code;
                        const newDiscount = parseFloat(e.target.value);
                        if (!isNaN(newDiscount) && newDiscount >= 0) {
                            const item = cart.find(item => item.code === code);
                            if (item) {
                                item.discount = newDiscount;
                                item.isManual = true; 
                                e.target.classList.add('manual-locked');
                                e.target.classList.remove('class-rule-active');
                                calculateTotal();
                            }
                        }
                    });
                    input.addEventListener('change', () => {
                        saveCart();
                        updateCartDisplay();
                    });
                });

                // 同步框監聽
                document.querySelectorAll('.sync-check').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            const targetClass = e.target.dataset.class;
                            const targetCode = e.target.dataset.code;
                            const triggerItem = cart.find(i => i.code === targetCode);
                            
                            if (triggerItem && targetClass) {
                                const newRuleValue = triggerItem.discount;
                                sessionRules[targetClass] = newRuleValue;
                                localStorage.setItem('sessionRules', JSON.stringify(sessionRules));

                                cart.forEach(item => {
                                    if (item.class === targetClass) {
                                        item.isManual = false; 
                                        item.discount = newRuleValue;
                                    }
                                });
                                
                                alert(`已設定分類 [${targetClass}] 全部為 ${newRuleValue} 折`);
                                calculateTotal();
                                updateCartDisplay();
                                saveCart();
                            }
                        }
                    });
                });
            };

            const calculateTotal = () => {
                let total = 0;
                cart = cart.filter(item => item.quantity !== 0);
                cart.forEach(item => {
                    const discountedPrice = item.price * item.quantity * (item.discount / 100);
                    total += discountedPrice;
                });
                totalAmountElement.textContent = Math.round(total);
                calculateChange();
            };

            const calculateChange = () => {
                const totalAmount = parseFloat(totalAmountElement.textContent);
                const paidAmount = parseFloat(paidAmountInput.value);
                const change = paidAmount - totalAmount;
                changeAmountElement.textContent = isNaN(change) ? "0" : Math.round(change);
            };

            paidAmountInput.addEventListener('input', calculateChange);
            const saveCart = () => { localStorage.setItem('cart', JSON.stringify(cart)); };
            const saveSummary = () => {
                localStorage.setItem('clients', JSON.stringify(clients));
                localStorage.setItem('overallSummary', JSON.stringify(overallSummary));
                localStorage.setItem('clientCounter', JSON.stringify(clientCounter));
            };

            // --- 混合支付與結帳 ---
            const handleCulturalCoinCheckout = () => {
                if (cart.length === 0) {
                    if (!hasShownEmptyCartAlert) { alert('購物車為空，無法結帳'); POSAudio.error(); hasShownEmptyCartAlert = true; }
                    return;
                }
                hasShownEmptyCartAlert = false;
                const totalAmount = parseFloat(totalAmountElement.textContent);
                let coinAmountStr = prompt(`訂單總額為 ${totalAmount} 元。\n請輸入文化幣支付金額：`, totalAmount);
                if (coinAmountStr === null) return;
                let coinAmount = parseInt(coinAmountStr);
                if (isNaN(coinAmount) || coinAmount < 0) { alert("請輸入有效的金額！"); POSAudio.error(); return; }
                if (coinAmount > totalAmount) { alert("文化幣金額不能大於訂單總額！"); POSAudio.error(); coinAmount = totalAmount; }

                const cashAmount = totalAmount - coinAmount;
                let methodStr = "";
                if (cashAmount > 0 && coinAmount > 0) methodStr = `文化幣(${coinAmount}) + 現金(${cashAmount})`;
                else if (coinAmount > 0 && cashAmount === 0) methodStr = `文化幣全額(${coinAmount})`;
                else methodStr = `現金(${totalAmount})`;

                triggerButtonAnimation(btnF9);
                performCheckout(methodStr, true); 
            };

            const triggerButtonAnimation = (btnElement) => {
                if(!btnElement) return;
                btnElement.classList.add('animate-click');
                setTimeout(() => { btnElement.classList.remove('animate-click'); }, 500);
            };

            const performCheckout = (paymentMethod, isComposite = false) => {
                if (cart.length === 0) {
                    if (!hasShownEmptyCartAlert) { alert('購物車為空，無法結帳'); POSAudio.error(); hasShownEmptyCartAlert = true; }
                    return;
                }
                hasShownEmptyCartAlert = false;

                if (!isComposite) {
                     if(paymentMethod === '信用卡') triggerButtonAnimation(btnF7);
                     if(paymentMethod === 'LINE PAY') triggerButtonAnimation(btnF8);
                     if(paymentMethod === '現金') triggerButtonAnimation(btnF10);
                }
                
                POSAudio.success();
                const totalAmount = parseFloat(totalAmountElement.textContent);
                const clientId = generateClientId();
                
                clients[clientId] = {
                    id: clientId,
                    amount: totalAmount,
                    paymentMethod: paymentMethod, 
                    items: JSON.parse(JSON.stringify(cart)),
                    isValid: true // [NEW] 預設為有效訂單
                };

                cart.forEach(item => {
                    if (!overallSummary[item.code]) {
                        overallSummary[item.code] = { code: item.code, name: item.name, totalQuantity: 0, totalAmount: 0 };
                    }
                    overallSummary[item.code].totalQuantity += item.quantity;
                    overallSummary[item.code].totalAmount += item.price * item.quantity * (item.discount / 100);
                });

                // [NEW] 結帳完成，清空價格覆寫記憶 (符合"除非刪除整筆訂單就重來"的邏輯，這裡指單次交易結束歸零)
                // 根據您的需求："輸入在其中之後，就會往後價格都會跟著這價格，除非刪除整筆訂單就重來"
                // 這裡我們選擇在「結帳後」清除，或者您可以選擇不清除(跨訂單記憶)。
                // 依照通俗POS邏輯，結帳後通常會重置臨時改價。若您希望跨訂單保留，請註解掉下面這行：
                priceOverrides = {}; 
                localStorage.setItem('priceOverrides', JSON.stringify(priceOverrides));

                cart = [];
                updateCartDisplay();
                calculateTotal();
                updateSummaryTable();
                saveSummary();
                clientCounter++;
                localStorage.setItem('clientCounter', JSON.stringify(clientCounter)); 
                localStorage.removeItem('cart');
                productCodeInput.focus(); 
                paidAmountInput.value = 1000;
            };

            btnF7.addEventListener('click', () => performCheckout('信用卡'));
            btnF8.addEventListener('click', () => performCheckout('LINE PAY'));
            btnF9.addEventListener('click', () => handleCulturalCoinCheckout()); 
            btnF10.addEventListener('click', () => performCheckout('現金'));

            document.addEventListener('keydown', (e) => {
                if (cart.length > 0) {
                    switch(e.key) {
                        case 'F10': e.preventDefault(); performCheckout('現金'); break;
                        case 'F9': e.preventDefault(); handleCulturalCoinCheckout(); break;
                        case 'F8': e.preventDefault(); performCheckout('LINE PAY'); break;
                        case 'F7': e.preventDefault(); performCheckout('信用卡'); break;
                    }
                }
            });

            // --- 搜尋與輸入 ---
            const parseProductInput = (input) => {
                const pattern = /^(\d+)\*([\w-]+)$/;
                const match = input.match(pattern);
                if (match) return { quantity: parseInt(match[1], 10), code: match[2] };
                return null;
            };

            productCodeInput.addEventListener('input', (e) => {
                resetIdleTimer();
                const codeOrBarcode = e.target.value.trim().toLowerCase(); 
                if (!e.isTrusted) return;
                const parsedInput = parseProductInput(codeOrBarcode);

                if (parsedInput) {
                    const product = products[parsedInput.code];
                    if (product) {
                        if (parsedInput.quantity) product.quantity = parsedInput.quantity;
                        addProductToCart(product.code);
                        e.target.value = ''; 
                        productInfoElement.textContent = '';
                    }
                } else {
                    const product = Object.values(products).find(product => product.code.toLowerCase() === codeOrBarcode || product.barcode === codeOrBarcode);
                    if (product) productInfoElement.textContent = `${product.name} ${Math.round(product.price)}元 庫存:${product.qty}`;
                    else productInfoElement.textContent = '';
                }
            });

            keywordSearchInput.addEventListener('input', (e) => {
                const keywords = e.target.value.trim().toLowerCase().split(' ');
                const matchedProducts = Object.values(products).filter(product => 
                    keywords.every(keyword => 
                        product.name.toLowerCase().includes(keyword) ||
                        product.code.toLowerCase().includes(keyword) ||
                        (product.barcode && product.barcode.includes(keyword))
                    )
                );

                searchResultsElement.innerHTML = '';
                const displayProducts = matchedProducts.slice(0, 3); 

                displayProducts.forEach(product => {
                    const resultItem = document.createElement('div');
                    resultItem.textContent = `${product.code} ｜ ${product.name} ｜ ${Math.round(product.price)}元`;
                    const selectButton = document.createElement('button');
                    selectButton.textContent = '送出計算';
                    selectButton.addEventListener('click', () => {
                        productCodeInput.value = product.code;
                        addProductToCart(product.code);
                        productInfoElement.textContent = `${product.name} ${Math.round(product.price)}元 庫存:${product.qty}`;
                        searchResultsElement.innerHTML = '';
                        keywordSearchInput.value = ''; 
                    });
                    resultItem.appendChild(selectButton);
                    searchResultsElement.appendChild(resultItem);
                });

                if (matchedProducts.length > 3) {
                    const showMoreButton = document.createElement('button');
                    showMoreButton.textContent = `顯示更多 (還有 ${matchedProducts.length - 3} 筆)`;
                    showMoreButton.addEventListener('click', () => {
                        searchResultsElement.innerHTML = '';
                        matchedProducts.slice(0, 20).forEach(product => {
                            const resultItem = document.createElement('div');
                            resultItem.textContent = `${product.code} ｜ ${product.name} ｜ ${Math.round(product.price)}元`;
                            const selectButton = document.createElement('button');
                            selectButton.textContent = '送出計算';
                            selectButton.addEventListener('click', () => {
                                productCodeInput.value = product.code;
                                addProductToCart(product.code);
                                productInfoElement.textContent = `${product.name} ${Math.round(product.price)}元 庫存:${product.qty}`;
                                searchResultsElement.innerHTML = '';
                                keywordSearchInput.value = ''; 
                            });
                            resultItem.appendChild(selectButton);
                            searchResultsElement.appendChild(resultItem);
                        });
                    });
                    searchResultsElement.appendChild(showMoreButton);
                }
            });

            productCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const codeOrBarcode = e.target.value.trim().toLowerCase();
                    const product = Object.values(products).find(product => product.code.toLowerCase() === codeOrBarcode || product.barcode === codeOrBarcode);
                    if (product) {
                        addProductToCart(product.code);
                        e.target.value = ''; 
                        productInfoElement.textContent = '';
                    } else {
                        alert('找不到商品'); POSAudio.error();
                    }
                }
            });

            // --- 統計與匯出 ---
            const calculatePaymentStats = () => {
                let stats = { cash: 0, credit: 0, linepay: 0, culture: 0 };
                Object.values(clients).forEach(client => {
                    if(!client.isValid) return; // 跳過作廢訂單

                    const method = client.paymentMethod || '現金';
                    if (method === '信用卡') stats.credit += client.amount;
                    else if (method === 'LINE PAY') stats.linepay += client.amount;
                    else if (method === '現金') stats.cash += client.amount;
                    else if (method.includes('文化幣')) {
                        const coinMatch = method.match(/文化幣.*?\((\d+)\)/);
                        if (coinMatch && coinMatch[1]) stats.culture += parseInt(coinMatch[1]);
                        const cashMatch = method.match(/現金\((\d+)\)/);
                        if (cashMatch && cashMatch[1]) stats.cash += parseInt(cashMatch[1]);
                    }
                });
                return stats;
            };

            const updateSummaryTable = () => {
                summaryTableBody.innerHTML = '';
                overallSummaryTableBody.innerHTML = '';

                // 重建 Overall Summary (因為可能會有作廢操作，需動態重算)
                let tempOverall = {};
                
                // 排序並顯示客戶訂單
                Object.values(clients).sort((a,b) => b.id.localeCompare(a.id)).forEach(client => {
                    const row = document.createElement('tr');
                    const method = client.paymentMethod || '現金';
                    
                    // 若已作廢，添加樣式
                    if(!client.isValid) {
                        row.classList.add('void-order');
                    } else {
                        // 只有有效訂單才加入總覽統計
                        client.items.forEach(item => {
                            if (!tempOverall[item.code]) tempOverall[item.code] = { code: item.code, name: item.name, totalQuantity: 0, totalAmount: 0 };
                            tempOverall[item.code].totalQuantity += item.quantity;
                            tempOverall[item.code].totalAmount += item.price * item.quantity * (item.discount / 100);
                        });
                    }

                    row.innerHTML = `
                        <td><a href="#" class="client-link" data-client-id="${client.id}">${client.id}</a> ${!client.isValid ? '(已作廢)' : ''}</td>
                        <td>${Math.round(client.amount)}</td>
                        <td>
                            <button class="btn-change-pay" data-client-id="${client.id}">${method}</button>
                        </td>
                        <td class="btn-action-group">
                            ${client.isValid ? `<button class="btn-void" data-client-id="${client.id}">作廢</button>` : `<button class="btn-void" data-client-id="${client.id}">復原</button>`}
                            <button class="btn-del" data-client-id="${client.id}">刪除</button>
                        </td>
                    `;
                    summaryTableBody.appendChild(row);
                });

                // 更新總覽表
                const sortedSummary = Object.values(tempOverall).sort((a, b) => a.code.localeCompare(b.code));
                sortedSummary.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.code}</td>
                        <td>${item.name}</td>
                        <td>${item.totalQuantity}</td>
                        <td>${Math.round(item.totalAmount)}</td>
                    `;
                    overallSummaryTableBody.appendChild(row);
                });

                const overallTotalAmount = sortedSummary.reduce((sum, item) => sum + item.totalAmount, 0);
                overallTotalAmountElement.textContent = Math.round(overallTotalAmount);

                // 計算有效訂單數
                const validOrders = Object.values(clients).filter(c => c.isValid).length;
                const averageOrderAmount = validOrders > 0 ? Math.round(overallTotalAmount / validOrders) : 0;
                totalOrdersElement.textContent = validOrders;
                averageAmountElement.textContent = averageOrderAmount;
                
                const stats = calculatePaymentStats();
                paymentStatsElement.innerHTML = `
                    <div class="stat-item">現金總計: <b>${stats.cash}</b></div>
                    <div class="stat-item">信用卡: <b>${stats.credit}</b></div>
                    <div class="stat-item">LINE PAY: <b>${stats.linepay}</b></div>
                    <div class="stat-item">文化幣: <b>${stats.culture}</b></div>
                `;

                // 更新記帳模式中的系統現金
                sysCashTotalEl.textContent = stats.cash;
                updateAccountingCalc(); // 重新計算差異

                attachHistoryEvents();
            };

            const attachHistoryEvents = () => {
                // 修改付款方式
                document.querySelectorAll('.btn-change-pay').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const clientId = e.target.dataset.clientId;
                        const client = clients[clientId];
                        if(!client.isValid) return alert("已作廢訂單無法修改");

                        const newMethod = prompt("請輸入新付款方式 (1:現金, 2:刷卡, 3:LINE PAY, 4:文化幣)", "1");
                        if(!newMethod) return;

                        let finalMethod = client.paymentMethod;
                        if(newMethod === '1' || newMethod === '現金') finalMethod = '現金';
                        else if(newMethod === '2' || newMethod === '信用卡') finalMethod = '信用卡';
                        else if(newMethod === '3' || newMethod === 'LINE PAY') finalMethod = 'LINE PAY';
                        else if(newMethod === '4' || newMethod === '文化幣') {
                            const coinAmt = prompt("請輸入文化幣金額 (剩餘為現金)", client.amount);
                            if(coinAmt && !isNaN(coinAmt)) {
                                const c = parseInt(coinAmt);
                                const cash = client.amount - c;
                                finalMethod = `文化幣(${c}) + 現金(${cash})`;
                            }
                        }
                        
                        clients[clientId].paymentMethod = finalMethod;
                        saveSummary();
                        updateSummaryTable();
                    });
                });

                // 作廢/復原
                document.querySelectorAll('.btn-void').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const clientId = e.target.dataset.clientId;
                        clients[clientId].isValid = !clients[clientId].isValid;
                        saveSummary();
                        updateSummaryTable();
                    });
                });

                // 刪除 (JSON刪除)
                document.querySelectorAll('.btn-del').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const clientId = e.target.dataset.clientId;
                        if (confirm('【警告】這將完全刪除此筆資料(JSON紀錄)，無法復原。\n確定要刪除嗎？')) {
                            delete clients[clientId];
                            saveSummary();
                            updateSummaryTable();
                        }
                    });
                });

                document.querySelectorAll('.client-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const clientId = e.target.dataset.clientId;
                        showClientDetails(clientId);
                    });
                });
            };

            const showClientDetails = (clientId) => {
                const client = clients[clientId];
                if (client) {
                    const method = client.paymentMethod || '現金';
                    const items = client.items.map(item => `${item.code} ｜ ${item.name} x ${item.quantity} (${Math.round(item.price*item.quantity)})`).join('\n');
                    alert(`客戶：${clientId} ${!client.isValid?'(已作廢)':''}\n付款方式：${method}\n\n購買商品：\n${items}`);
                }
            };

            // --- 記帳模式邏輯 ---
            window.clearAccountingInputs = () => {
                moneyInputs.forEach(input => input.value = '');
                updateAccountingCalc();
                localStorage.removeItem('acctInitial');
                localStorage.removeItem('acctExpenses');
                // 清除 moneyInputs localStorage
                moneyInputs.forEach(input => localStorage.removeItem(`acctMoney_${input.dataset.val}`));
            };

            const updateAccountingCalc = () => {
                let drawerTotal = 0;
                let formulaStr = "";

                moneyInputs.forEach(input => {
                    const val = parseInt(input.dataset.val);
                    const count = parseInt(input.value) || 0;
                    if(count > 0) {
                        drawerTotal += val * count;
                        formulaStr += `${val}*${count}+`;
                    }
                    // 儲存
                    localStorage.setItem(`acctMoney_${val}`, input.value);
                });

                const initial = parseInt(initialCashInput.value) || 0;
                const expenses = parseInt(expensesCashInput.value) || 0;

                localStorage.setItem('acctInitial', initial);
                localStorage.setItem('acctExpenses', expenses);

                const netCash = drawerTotal - initial + expenses; 
                // 公式：盤點總額 - 初始備用金 + 支出單據 = 應該收到的營收現金
                // (因為支出單據是把錢拿走了，所以盤點會少，要加回來才能跟系統營收比對)
                // 修正邏輯：
                // 假設系統說營收 1000。
                // 錢櫃應該有：1000 + 初始(11000) - 支出(100) = 11900。
                // 盤點到：11900。
                // 實際營收 = 盤點(11900) - 初始(11000) + 支出(100) = 1000。 正確。

                calcDrawerTotalEl.textContent = drawerTotal;
                calcInitialEl.textContent = initial;
                calcExpensesEl.textContent = expenses;
                calcNetCashEl.textContent = netCash;

                const sysCash = parseInt(sysCashTotalEl.textContent) || 0;
                const diff = netCash - sysCash;
                
                cashDiffEl.textContent = diff;
                if(diff === 0) {
                    cashDiffEl.style.color = 'green';
                    cashDiffRow.style.backgroundColor = '#e8f5e9';
                } else {
                    cashDiffEl.style.color = 'red';
                    cashDiffRow.style.backgroundColor = '#ffebee';
                }
            };

            moneyInputs.forEach(input => input.addEventListener('input', updateAccountingCalc));
            initialCashInput.addEventListener('input', updateAccountingCalc);
            expensesCashInput.addEventListener('input', updateAccountingCalc);

            // 備份
            backupBtn.addEventListener('click', () => {
                const backupData = {
                    cart: cart,
                    clients: clients,
                    overallSummary: overallSummary,
                    clientCounter: clientCounter,
                    sessionRules: sessionRules, 
                    priceOverrides: priceOverrides,
                    notes: notesElement.value,
                    timestamp: new Date().toISOString()
                };
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                a.download = `pos_backup_${dateStr}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('備份已下載！');
            });

            // 還原
            restoreBtn.addEventListener('click', () => {
                if (confirm('注意：還原備份將會「覆蓋」目前的訂單資料。確定要繼續嗎？')) importFileInput.click();
            });

            importFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.clients) {
                            localStorage.setItem('cart', JSON.stringify(data.cart || []));
                            localStorage.setItem('clients', JSON.stringify(data.clients || {}));
                            // overallSummary 改由前端動態重算，保持一致性
                            localStorage.setItem('overallSummary', JSON.stringify({})); 
                            localStorage.setItem('clientCounter', JSON.stringify(data.clientCounter || 1));
                            localStorage.setItem('sessionRules', JSON.stringify(data.sessionRules || {}));
                            localStorage.setItem('priceOverrides', JSON.stringify(data.priceOverrides || {}));
                            localStorage.setItem('notes', data.notes || '');
                            alert('資料還原成功！網頁將重新整理。');
                            location.reload();
                        } else {
                            alert('錯誤：備份檔案格式不正確。');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('錯誤：無法解析備份檔案。');
                    }
                };
                reader.readAsText(file);
                importFileInput.value = '';
            });

            // CSV 匯出
            exportCsvBtn.addEventListener('click', () => {
                try {
                    const notes = localStorage.getItem('notes') || '無備註';
                    const stats = calculatePaymentStats();
                    const overallTotalAmount = Object.values(overallSummary).reduce((sum, item) => sum + item.totalAmount, 0);

                    const summaryRows = [
                        ['客戶名稱', '消費金額', '付款方式', '狀態'], 
                        ...Object.values(clients).map(client => [
                            client.id, 
                            Math.round(client.amount),
                            client.paymentMethod || '現金',
                            client.isValid ? '有效' : '已作廢'
                        ]),
                        [],
                        ['商品代碼', '名稱', '總數量', '總金額'],
                        ...Object.values(overallSummary).map(item => {
                            if (!item || !item.code || !item.name) return ['錯誤數據'];
                            return [item.code, item.name, item.totalQuantity, Math.round(item.totalAmount)];
                        }),
                        [],
                        ['總金額', Math.round(overallTotalAmount)],
                        ['現金總收', stats.cash],
                        ['信用卡總收', stats.credit],
                        ['LINE PAY總收', stats.linepay],
                        ['文化幣總收', stats.culture],
                        [],
                        ['備註'],
                        [notes],
                        [],
                        ['盤點記錄'],
                        ['盤點現金總額', calcDrawerTotalEl.textContent],
                        ['初始備用金', calcInitialEl.textContent],
                        ['支出憑證', calcExpensesEl.textContent],
                        ['實際現金營收', calcNetCashEl.textContent],
                        ['差異金額', cashDiffEl.textContent]
                    ];

                    const detailsRows = [
                        ['詳細內容：'], 
                        ['客戶名稱', '付款方式', '商品名稱', '數量', '單價', '折扣', '小計', '狀態'],
                        ...Object.values(clients).flatMap(client =>
                            client.items.map(item => [
                                client.id,
                                client.paymentMethod || '現金',
                                item.name,
                                item.quantity,
                                Math.round(item.price),
                                `${item.discount}%`,
                                Math.round(item.price * item.quantity * (item.discount / 100)),
                                client.isValid ? '有效' : '已作廢'
                            ])
                        )
                    ];

                    const combinedRows = [...summaryRows, ...detailsRows];
                    const csvContent = combinedRows.map(e => e.join(",")).join("\n");
                    const blob = new Blob([`\ufeff${csvContent}`], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `sales_combined_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url); 
                } catch (error) {
                    console.error('CSV匯出錯誤:', error);
                    alert('CSV匯出過程出現問題，請檢查數據是否完整。');
                }
            });

            clearAllBtn.addEventListener('click', () => {
                if (confirm('確定要刪除全部訂單？此操作無法撤銷。')) {
                    if (confirm('再次確認，確定要刪除全部訂單嗎？')) {
                        localStorage.clear(); 
                        location.reload();
                        alert('已成功刪除全部訂單。');
                    }
                }
            });

            // --- 啟動 ---
            loadDiscountRates(); 
            loadProducts().then(() => {
                updateCartDisplay();
                updateSummaryTable();
            });
            calculateChange(); 
        });
    </script>
</body>
</html>
