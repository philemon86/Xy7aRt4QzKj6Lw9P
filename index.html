<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>腓利門雲POS - 2026書展版</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        /* --- 核心配色：大地色系優化 --- */
        :root {
            --bg-color: #F4E4C1;       /* 沙漠砂 (背景) */
            --primary-btn: #A0522D;    /* 陶土褐 (主要按鈕) */
            --primary-btn-hover: #8B4513;
            --border-color: #D2B48C;   /* 淺褐 (邊框) */
            --input-bg: #FFF8DC;       /* 玉米絲 (輸入框) */
            --text-color: #333;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            background-color: var(--bg-color);
            padding-bottom: 50px;
            color: var(--text-color);
        }

        /* 父級容器 */
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
            margin-top: 20px;
        }

        .container-half {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 48%;
            margin-bottom: 20px;
            min-height: 300px;
            box-sizing: border-box;
            position: relative;
            border-top: 4px solid var(--primary-btn);
        }

        /* 全寬容器用於記帳模式 */
        .container-full {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            margin-bottom: 20px;
            box-sizing: border-box;
            border-top: 4px solid var(--primary-btn);
        }

        .header, .form-group, .table-container, .payment-info, .notes-container, .accounting-container {
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header button, .form-group button, .btn-group button, .acct-btn {
            background-color: var(--primary-btn);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
            font-weight: bold;
            transition: background 0.2s;
        }

        .header button:hover, .form-group button:hover {
            background-color: var(--primary-btn-hover);
        }
        
        #clear-all-btn { background-color: #a94442; }
        #clear-all-btn:hover { background-color: #8a3331; }

        .form-group input, .notes-container textarea {
            width: calc(100% - 20px);
            padding: 12px;
            font-size: 1.1em;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg);
        }

        .notes-container textarea {
            resize: none;
            height: 100px;
        }

        .total {
            font-size: 1.8em;
            font-weight: bold;
            color: #FFF;
            background-color: var(--primary-btn);
            padding: 15px;
            border-radius: 8px 8px 0 0;
            text-align: right;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .payment-info {
            background-color: #FFFFFF;
            border-radius: 0 0 8px 8px;
            border-top: 2px solid var(--primary-btn);
            padding: 15px;
            display: flex;
            flex-direction: column; 
            gap: 15px;
        }

        .payment-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .payment-info > span, .payment-details > span {
            color: var(--primary-btn);
            font-weight: bold;
            font-size: 1.2em;
        }

        .payment-info input#paid-amount {
            max-width: 120px;
            padding: 5px;
            font-size: 1.4em;
            text-align: right;
            border: 2px solid var(--border-color);
        }

        /* 底部四個結帳按鈕的樣式 */
        .checkout-buttons-area {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }

        .checkout-btn {
            flex: 1; 
            background-color: var(--primary-btn);
            border: none;
            border-radius: 5px;
            padding: 15px 10px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding-left: 15px;
        }

        .checkout-btn:hover {
            background-color: var(--primary-btn-hover);
            transform: translateY(-2px);
        }

        .checkout-btn:active { transform: translateY(0); }

        .checkout-btn .btn-key {
            font-size: 2.2em !important;
            font-weight: 800 !important;
            color: #FFF8DC !important;
            margin-bottom: 5px;
            display: block;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            line-height: 1;
        }

        .checkout-btn .btn-label {
            font-size: 0.9em !important;
            color: #F5F5DC !important;
            display: block;
            font-weight: normal;
        }

        /* 30秒提醒動畫 */
        .btn-alert {
            animation: heartBeat 1s infinite;
            background-color: #ff8c00 !important;
            transform: scale(1.05);
            z-index: 10;
        }

        @keyframes heartBeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .table-container { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        th {
            font-size: 0.9em;
            color: var(--primary-btn);
            background-color: #f9f4e8;
        }

        td { font-size: 0.9em; }

        .bottom-total {
            border-radius: 8px;
            margin-top: 10px;
        }

        td input[type="number"] {
            width: 60px;
            padding: 5px;
            font-size: 1em;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .stats-info {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed var(--border-color);
            line-height: 1.6;
        }
        
        .stat-item {
            display: inline-block;
            margin-right: 15px;
        }
        
        .stat-item b { color: var(--primary-btn); }

        @media (max-width: 768px) {
            .flex-container {
                flex-direction: column;
                align-items: center;
                padding: 0 10px;
            }
            .container-half, .container-full {
                width: 100%;
                margin-bottom: 20px;
            }
            .checkout-buttons-area { flex-wrap: wrap; }
            .checkout-btn { min-width: 45%; }
        }

        .animate-click { animation: pulse-green 0.5s ease-out; }

        @keyframes pulse-green {
            0% { transform: scale(1); background-color: var(--primary-btn); }
            50% { transform: scale(1.05); background-color: #28a745; }
            100% { transform: scale(1); background-color: var(--primary-btn); }
        }

        .discount-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .sync-option {
            display: none;
            margin-top: 4px;
            font-size: 0.75em;
            color: var(--primary-btn);
            background-color: #fff8dc;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid var(--border-color);
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 10;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        .discount-wrapper:focus-within .sync-option {
            display: flex;
            align-items: center;
        }

        .manual-locked {
            border: 2px solid #a94442 !important; 
            background-color: #fff0f0 !important;
        }
        
        .class-rule-active {
            border: 2px solid #28a745 !important;
            background-color: #f0fff0 !important;
        }

        /* --- 記帳模式樣式 --- */
        .accounting-split-wrapper {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .accounting-col {
            flex: 1;
            min-width: 300px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            background-color: #FFF8DC;
        }
        .accounting-col h4 {
            margin-top: 0;
            color: var(--primary-btn);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            text-align: center;
        }
        .accounting-col.initial-col {
            background-color: #f0f8ff; /* 初始金額欄位底色不同 */
            border-color: #b0c4de;
        }

        .money-input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 4px 8px;
            background-color: rgba(255,255,255,0.6);
            border-radius: 3px;
        }

        .money-input-group label {
            font-size: 0.95em;
            font-weight: bold;
            color: #555;
            width: 80px;
        }

        .money-input-group input {
            width: 100px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            padding: 5px;
            text-align: right;
            border-radius: 3px;
        }

        .acct-summary {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            border: 2px solid var(--primary-btn);
            margin-top: 15px;
        }

        .acct-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .acct-row.highlight {
            border-top: 1px solid #ccc;
            padding-top: 8px;
            font-weight: bold;
            color: #a94442;
        }

        .btn-change-pay {
            background-color: #fff;
            border: 1px solid var(--primary-btn);
            color: var(--primary-btn);
            padding: 2px 6px;
            font-size: 0.8em;
            cursor: pointer;
            border-radius: 3px;
        }
        .btn-change-pay:hover {
            background-color: var(--primary-btn);
            color: white;
        }

        .void-order {
            text-decoration: line-through;
            color: #999 !important;
            background-color: #f0f0f0;
        }
        .void-order span, .void-order a, .void-order button { opacity: 0.6; }
        
        .btn-action-group button {
            margin-left: 2px;
            padding: 2px 5px;
            font-size: 0.8em;
        }
        
        .btn-void { background-color: #666; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .btn-del { background-color: #a94442; color: white; border: none; border-radius: 3px; cursor: pointer; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-align: center;
            border: 2px solid var(--primary-btn);
        }

        .modal-title {
            margin-top: 0;
            color: var(--primary-btn);
            margin-bottom: 20px;
        }

        .modal-btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .modal-btn {
            padding: 15px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            color: white;
            transition: transform 0.1s;
        }
        
        .modal-btn:active { transform: scale(0.95); }

        .btn-m-cash { background-color: #28a745; }
        .btn-m-card { background-color: #007bff; }
        .btn-m-line { background-color: #20c997; }
        .btn-m-culture { background-color: #fd7e14; }
        .btn-m-cancel { background-color: #6c757d; width: 100%; margin-top: 10px; padding: 10px; }

    </style>
</head>
<body>
    <input type="file" id="import-file" accept=".json" style="display: none;">

    <div class="flex-container">
        <div class="container-half">
            <div class="header">
                <div>
                    <span id="title" style="font-size:1.5em; font-weight:bold; color: var(--primary-btn);">腓利門雲POS</span>
                </div>
            </div>
            <div class="header" style="justify-content: flex-end;">
                <span id="current-date" style="margin-right: auto; font-weight:bold;"></span>
                <div class="btn-group">
                    <button id="backup-btn" style="background-color: #4682B4;">備份</button>
                    <button id="restore-btn" style="background-color: #20B2AA;">還原</button>
                    <button id="export-csv-btn">匯出 CSV</button>
                    <button id="export-pilot-btn" style="background-color: #2E7D32;">匯出 Pilot 會計檔</button>
                    <button id="clear-all-btn">清空</button>
                </div>
            </div>
            <div class="form-group">
                <label for="product-code">商品掃描 (輸入代碼/條碼)：</label>
                <input type="text" id="product-code" placeholder="掃描後按 Enter 自動加入" autofocus>
                <div id="product-info" style="color: var(--primary-btn); margin-top:5px; font-weight:bold; height: 1.2em;"></div>
            </div>
            <div class="form-group search-container">
                <label for="keyword-search">關鍵字搜尋：</label>
                <input type="text" id="keyword-search" placeholder="名稱 / 代碼 / 條碼">
                <div id="search-results" class="search-results" style="margin-top:10px;"></div>
            </div>
            <div id="db-status" style="font-size:0.8em; color:gray; text-align:right;"></div>
        </div>

        <div class="container-half">
            <div class="table-container">
                <div class="table-title" style="font-weight:bold; color:var(--primary-btn); margin-bottom:5px;">本次結帳明細</div>
                <table id="cart-table">
                    <thead>
                        <tr>
                            <th>名稱</th>
                            <th>單價</th>
                            <th>數量</th>
                            <th style="min-width: 100px;">折扣 %</th>
                            <th>小計</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="total">應付金額：<span id="total-amount">0</span> 元</div>
            
            <div class="payment-info">
                <div class="payment-details">
                    <span>實付金額：<input type="number" id="paid-amount" value="1000"></span>
                    <span>找錢：<span id="change-amount">0</span> 元</span>
                </div>
                
                <div class="checkout-buttons-area">
                    <button id="btn-f7" class="checkout-btn">
                        <span class="btn-key">F7</span>
                        <span class="btn-label">信用卡</span>
                    </button>
                    <button id="btn-f8" class="checkout-btn">
                        <span class="btn-key">F8</span>
                        <span class="btn-label">LINE PAY</span>
                    </button>
                    <button id="btn-f9" class="checkout-btn">
                        <span class="btn-key">F9</span>
                        <span class="btn-label">文化幣</span>
                    </button>
                    <button id="btn-f10" class="checkout-btn">
                        <span class="btn-key">F10</span>
                        <span class="btn-label">現金</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-container">
        <div class="container-half">
            <div class="table-title">
                <b>歷史訂單 (作廢/刪除/修改付款)</b> <br>
                訂單數: <span id="total-orders">0</span> | 平均消費: <span id="average-amount">0</span> 元
                <div id="payment-stats" class="stats-info">
                </div>
            </div>
            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table id="summary-table">
                    <thead>
                        <tr>
                            <th>單號</th>
                            <th>金額</th>
                            <th>付款</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="notes-container">
                <label for="notes">備註：</label>
                <textarea id="notes"></textarea>
            </div>
        </div>

        <div class="container-half">
            <div class="table-title">
                <b>今日銷售總覽</b>
            </div>
            <div class="table-container" style="max-height: 350px; overflow-y: auto;">
                <table id="overall-summary-table">
                    <thead>
                        <tr>
                            <th>代碼</th>
                            <th>品名</th>
                            <th>總量</th>
                            <th>總額</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="total bottom-total" style="font-size:1.5em;">營收總計：<span id="overall-total-amount">0</span> 元</div>
        </div>
    </div>

    <div class="flex-container">
        <div class="container-full">
            <div class="header">
                <b>記帳模式 (現金盤點與對帳)</b>
                <button onclick="clearAccountingInputs()">清空盤點數據</button>
            </div>
            
            <div class="accounting-container">
                <div class="accounting-split-wrapper">
                    <div class="accounting-col">
                        <h4>1. 現有現金盤點</h4>
                        <div class="money-input-group"><label>1000 元</label><input type="number" class="acct-count current" data-val="1000" min="0"></div>
                        <div class="money-input-group"><label>500 元</label><input type="number" class="acct-count current" data-val="500" min="0"></div>
                        <div class="money-input-group"><label>100 元</label><input type="number" class="acct-count current" data-val="100" min="0"></div>
                        <div class="money-input-group"><label>50 元</label><input type="number" class="acct-count current" data-val="50" min="0"></div>
                        <div class="money-input-group"><label>10 元</label><input type="number" class="acct-count current" data-val="10" min="0"></div>
                        <div class="money-input-group"><label>5 元</label><input type="number" class="acct-count current" data-val="5" min="0"></div>
                        <div class="money-input-group"><label>1 元</label><input type="number" class="acct-count current" data-val="1" min="0"></div>
                    </div>

                    <div class="accounting-col initial-col">
                        <h4>2. 初始金額設定 (11,000)</h4>
                        <div class="money-input-group"><label>1000 元</label><input type="number" class="acct-count initial" data-val="1000" min="0" value="1"></div>
                        <div class="money-input-group"><label>500 元</label><input type="number" class="acct-count initial" data-val="500" min="0" value="10"></div>
                        <div class="money-input-group"><label>100 元</label><input type="number" class="acct-count initial" data-val="100" min="0" value="30"></div>
                        <div class="money-input-group"><label>50 元</label><input type="number" class="acct-count initial" data-val="50" min="0" value="20"></div>
                        <div class="money-input-group"><label>10 元</label><input type="number" class="acct-count initial" data-val="10" min="0" value="64"></div>
                        <div class="money-input-group"><label>5 元</label><input type="number" class="acct-count initial" data-val="5" min="0" value="62"></div>
                        <div class="money-input-group"><label>1 元</label><input type="number" class="acct-count initial" data-val="1" min="0" value="50"></div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 10px; background-color: #ffebee; border-radius: 4px; border: 1px solid #ffcccb;">
                    <label style="font-weight:bold;">(-) 額外支出 (憑證)：</label>
                    <input type="number" id="expenses-cash" value="0" min="0" style="width: 100px; padding: 5px;">
                </div>
                
                <div class="acct-summary">
                    <div class="acct-row">
                        <span>盤點現金總額：</span>
                        <span id="calc-drawer-total">0</span>
                    </div>
                    <div class="acct-row" style="color: #666;">
                        <span>(-) 初始金額總計：</span>
                        <span id="calc-initial">0</span>
                    </div>
                     <div class="acct-row" style="color: #666;">
                        <span>(+) 支出費用憑證：</span>
                        <span id="calc-expenses">0</span>
                    </div>
                    <hr>
                    <div class="acct-row highlight">
                        <span>= 實際營業額 (現金)：</span>
                        <span id="calc-net-cash">0</span>
                    </div>
                    <div class="acct-row" style="color: #555; font-size: 0.9em;">
                        <span>(系統記錄現金營收：<span id="sys-cash-total">0</span>)</span>
                    </div>
                    <div class="acct-row" id="cash-diff-row" style="font-weight: bold; margin-top: 5px;">
                        <span>差異：</span>
                        <span id="cash-diff">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">選擇新的付款方式</h3>
            <div class="modal-btn-grid">
                <button class="modal-btn btn-m-cash" onclick="selectPaymentMethod('現金')">現金</button>
                <button class="modal-btn btn-m-card" onclick="selectPaymentMethod('信用卡')">信用卡</button>
                <button class="modal-btn btn-m-line" onclick="selectPaymentMethod('LINE PAY')">LINE PAY</button>
                <button class="modal-btn btn-m-culture" onclick="selectPaymentMethod('文化幣')">文化幣</button>
            </div>
            <button class="modal-btn btn-m-cancel" onclick="closePaymentModal()">取消</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM 元素獲取 ---
            const currentDateElement = document.getElementById('current-date');
            const keywordSearchInput = document.getElementById('keyword-search');
            const searchResultsElement = document.getElementById('search-results');
            const productCodeInput = document.getElementById('product-code');
            const paidAmountInput = document.getElementById('paid-amount');
            const productInfoElement = document.getElementById('product-info');
            const dbStatusElement = document.getElementById('db-status');
            const cartTableBody = document.querySelector('#cart-table tbody');
            const totalAmountElement = document.getElementById('total-amount');
            const changeAmountElement = document.getElementById('change-amount');
            const summaryTableBody = document.querySelector('#summary-table tbody');
            const overallSummaryTableBody = document.querySelector('#overall-summary-table tbody');
            const overallTotalAmountElement = document.getElementById('overall-total-amount');
            
            // 按鈕們
            const btnF7 = document.getElementById('btn-f7');
            const btnF8 = document.getElementById('btn-f8');
            const btnF9 = document.getElementById('btn-f9');
            const btnF10 = document.getElementById('btn-f10');
            const checkoutBtns = [btnF7, btnF8, btnF9, btnF10];
            
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const exportPilotBtn = document.getElementById('export-pilot-btn');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const backupBtn = document.getElementById('backup-btn');
            const restoreBtn = document.getElementById('restore-btn');
            const importFileInput = document.getElementById('import-file');

            const totalOrdersElement = document.getElementById('total-orders');
            const averageAmountElement = document.getElementById('average-amount');
            const paymentStatsElement = document.getElementById('payment-stats');
            const notesElement = document.getElementById('notes');

            // 記帳模式元素
            const expensesCashInput = document.getElementById('expenses-cash');
            const calcDrawerTotalEl = document.getElementById('calc-drawer-total');
            const calcInitialEl = document.getElementById('calc-initial');
            const calcExpensesEl = document.getElementById('calc-expenses');
            const calcNetCashEl = document.getElementById('calc-net-cash');
            const sysCashTotalEl = document.getElementById('sys-cash-total');
            const cashDiffRow = document.getElementById('cash-diff-row');
            const cashDiffEl = document.getElementById('cash-diff');

            // --- 狀態變數 ---
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            let products = {}; 
            let discountRates = {}; 
            let clients = JSON.parse(localStorage.getItem('clients')) || {};
            let overallSummary = JSON.parse(localStorage.getItem('overallSummary')) || {};
            let clientCounter = JSON.parse(localStorage.getItem('clientCounter')) || 1;
            let hasShownEmptyCartAlert = false;
            let sessionRules = JSON.parse(localStorage.getItem('sessionRules')) || {};
            let priceOverrides = JSON.parse(localStorage.getItem('priceOverrides')) || {};
            let idleTimer = null;
            const IDLE_TIMEOUT_MS = 30000; 

            // Modal 相關變數
            let editingClientId = null;
            const paymentModal = document.getElementById('payment-modal');

            // --- 商品資料庫 Hybrid 模式 (手動備用資料庫) ---
            // 若 CSV 讀取失敗，將使用此處資料。請在此填入您的書籍資料。
            const productDB = {
                "9789861234567": { code: "9789861234567", name: "範例書籍A", price: 350, qty: 100, class: "01" },
                "A001": { code: "A001", name: "測試商品B", price: 500, qty: 50, class: "02" },
                // 格式： "條碼/代碼": { code: "重複代碼", name: "書名", price: 價格, qty: 庫存, class: "分類代號" }
            };

            // --- 音效控制器 ---
            const POSAudio = {
                ctx: new (window.AudioContext || window.webkitAudioContext)(),
                playTone: function(freq, type, duration, startTime = 0) {
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime + startTime);
                    gain.gain.setValueAtTime(0.1, this.ctx.currentTime + startTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + startTime + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(this.ctx.currentTime + startTime);
                    osc.stop(this.ctx.currentTime + startTime + duration);
                },
                beep: function() { this.playTone(880, 'sine', 0.1); },
                error: function() { this.playTone(150, 'sawtooth', 0.3); },
                success: function() {
                    this.playTone(523.25, 'triangle', 0.1, 0);
                    this.playTone(659.25, 'triangle', 0.1, 0.05);
                    this.playTone(783.99, 'triangle', 0.2, 0.1);
                }
            };

            // --- Pilot 規格工具 ---
            function generateERI(type) {
                // ERI 產生邏輯: 0H5(主)/0H8(詳)/01E(付) + 固定指紋 + 亂數
                const prefix = { 'master': '0H5', 'detail': '0H8', 'pay': '01E' }[type];
                const fingerprint = "0010LU0"; 
                const chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                let suffix = "";
                for(let i=0; i<6; i++) suffix += chars.charAt(Math.floor(Math.random() * chars.length));
                return (prefix + fingerprint + suffix).substring(0, 16);
            }

            // --- 日期與初始化 ---
            const currentDate = new Date().toISOString().split('T')[0].replace(/-/g, '/');
            currentDateElement.textContent = `日期：${currentDate}`;
            notesElement.value = localStorage.getItem('notes') || '';
            notesElement.addEventListener('input', () => {
                localStorage.setItem('notes', notesElement.value);
            });

            // 記帳輸入框初始化
            expensesCashInput.value = localStorage.getItem('acctExpenses') || '0';
            
            document.querySelectorAll('.acct-count').forEach(input => {
                const key = `acct_${input.classList.contains('current')?'cur':'init'}_${input.dataset.val}`;
                const saved = localStorage.getItem(key);
                if(saved !== null) { input.value = saved; }
                input.addEventListener('input', () => {
                    updateAccountingCalc();
                    localStorage.setItem(key, input.value);
                });
            });
            expensesCashInput.addEventListener('input', () => {
                updateAccountingCalc();
                localStorage.setItem('acctExpenses', expensesCashInput.value);
            });

            const generateClientId = () => {
                const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}${month}${day}-${String(clientCounter).padStart(3, '0')}`;
            };

            const loadDiscountRates = () => {
                // 書房專用折扣表
                discountRates = {
                    "POS": 100, "02-2": 100, "09-2": 90, "09-5": 100, "09-4": 100, "09-1": 100, 
                    "09-3": 90, "06-1": 100, "07-1": 90, "07-2": 90, "07-3": 90, "07-4": 90, 
                    "07-5": 90, "07-6": 90, "07-7": 90, "06-2": 100, "02-1": 80, "08-2": 90, 
                    "08-5": 90, "08-3": 90, "08-4": 90, "08-1": 90, "12": 100, "03-2": 100, 
                    "02-3": 80, "03-4": 100, "04-2": 100, "11": 100, "03-1": 100, "04-1": 100, 
                    "01": 90, "05-2": 90, "05-1": 100, "03-3": 100
                };
            };

            // --- 修改後的商品讀取邏輯 (支援 CSV 與 內建DB) ---
            const loadProducts = async () => {
                try {
                    const response = await fetch('products.csv');
                    if (!response.ok) throw new Error('無法讀取CSV');
                    
                    const data = await response.text();
                    const lines = data.split('\n');
                    let headers = [];
                    let isHeader = true;

                    lines.forEach(line => {
                        const columns = line.split(',');
                        if (isHeader) {
                            headers = columns.map(header => header.trim());
                            isHeader = false;
                            return;
                        }
                        const product = {};
                        headers.forEach((header, index) => {
                            product[header] = columns[index]?.trim();
                        });

                        if (product['CODE'] && product['CNAME']) {
                            const defaultDiscount = discountRates[product['CLAS']] || 100;
                            products[product['CODE']] = {
                                code: product['CODE'],
                                name: product['CNAME'],
                                barcode: product['BARCODE'],
                                qty: parseInt(product['CQTY']) || 0,
                                price: parseFloat(product['PRICE']) || 0,
                                class: product['CLAS'], 
                                defaultDiscount: defaultDiscount
                            };
                        }
                    });
                    dbStatusElement.textContent = "已載入外部 CSV 商品資料";
                    dbStatusElement.style.color = "green";
                } catch (error) {
                    console.warn('CSV讀取失敗，切換至內建測試資料庫', error);
                    // 切換至內建 productDB
                    Object.values(productDB).forEach(p => {
                         const defaultDiscount = discountRates[p.class] || 100;
                         products[p.code] = {
                             ...p,
                             defaultDiscount: defaultDiscount
                         };
                    });
                    dbStatusElement.textContent = "CSV讀取失敗，使用內建/測試資料";
                    dbStatusElement.style.color = "orange";
                }
            };

            const calculateItemDiscount = (item) => {
                if (item.isManual) return item.discount;
                if (item.class && sessionRules[item.class] !== undefined) return sessionRules[item.class];
                return item.defaultDiscount || 100;
            };

            const addProductToCart = (code) => {
                resetIdleTimer();
                const product = products[code];
                const existingItem = cart.find(item => item.code === code);
                
                if (existingItem) {
                    existingItem.quantity += 1;
                    if (!existingItem.isManual) {
                        existingItem.discount = calculateItemDiscount(existingItem);
                    }
                    if (priceOverrides[code] !== undefined) {
                        existingItem.price = priceOverrides[code];
                    }
                } else {
                    const newItem = { 
                        ...product, 
                        quantity: 1,
                        isManual: false,
                        discount: 0 
                    };
                    if (priceOverrides[code] !== undefined) {
                        newItem.price = priceOverrides[code];
                    }
                    newItem.discount = calculateItemDiscount(newItem);
                    cart.push(newItem);
                }
                
                POSAudio.beep();
                updateCartDisplay();
                calculateTotal();
                saveCart();
                productCodeInput.value = ''; 
                productCodeInput.focus(); // 確保焦點回到輸入框
            };

            const resetIdleTimer = () => {
                if (idleTimer) clearTimeout(idleTimer);
                checkoutBtns.forEach(btn => btn.classList.remove('btn-alert'));
                if (cart.length > 0) {
                    idleTimer = setTimeout(() => {
                        checkoutBtns.forEach(btn => btn.classList.add('btn-alert'));
                    }, IDLE_TIMEOUT_MS);
                }
            };

            const updateCartDisplay = () => {
                cartTableBody.innerHTML = '';
                cart.forEach(item => {
                    const row = document.createElement('tr');
                    let inputClass = 'discount-input';
                    let statusTitle = "預設折扣";
                    if (item.isManual) {
                        inputClass += ' manual-locked';
                        statusTitle = "單品已鎖定";
                    } else if (sessionRules[item.class]) {
                        inputClass += ' class-rule-active';
                        statusTitle = `套用分類規則 (${item.class})`;
                    }

                    const priceStyle = priceOverrides[item.code] !== undefined ? 'border: 2px solid #8A6739; background-color:#fff8dc;' : '';

                    row.innerHTML = `
                        <td>${item.name} <br><small style="color:#888;">${item.class || '無分類'}</small></td>
                        <td><input type="number" name="price-${item.code}" value="${item.price}" step="0.1" min="0" style="width: 60px; ${priceStyle}" class="price-input" data-code="${item.code}"></td>
                        <td><input type="number" name="quantity-${item.code}" value="${item.quantity}" min="-1000" class="quantity-input" data-code="${item.code}"></td>
                        <td>
                            <div class="discount-wrapper" title="${statusTitle}">
                                <input type="number" value="${item.discount}" step="0.1" min="0" max="100" class="${inputClass}" data-code="${item.code}">
                                <label class="sync-option">
                                    <input type="checkbox" class="sync-check" data-class="${item.class}" data-code="${item.code}">
                                    同步修改 [${item.class || '無'}]
                                </label>
                            </div>
                        </td>
                        <td>${Math.round(item.price * item.quantity * (item.discount / 100))}</td>
                    `;
                    cartTableBody.appendChild(row);
                });

                attachCartEventListeners();
                resetIdleTimer();
            };

            const attachCartEventListeners = () => {
                const debounce = (func, delay) => {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), delay);
                    };
                };

                document.querySelectorAll('.quantity-input').forEach(input => {
                    input.addEventListener('input', debounce((e) => {
                        resetIdleTimer();
                        const code = e.target.dataset.code;
                        const newQuantity = parseInt(e.target.value);
                        if (!isNaN(newQuantity)) {
                            const item = cart.find(item => item.code === code);
                            if (item) {
                                item.quantity = newQuantity;
                                calculateTotal();
                                updateCartDisplay();
                                saveCart();
                            }
                        }
                    }, 500));
                });

                document.querySelectorAll('.price-input').forEach(input => {
                    input.addEventListener('input', debounce((e) => {
                        resetIdleTimer();
                        const code = e.target.dataset.code;
                        const newPrice = parseFloat(e.target.value);
                        if (!isNaN(newPrice) && newPrice >= 0) {
                            const item = cart.find(item => item.code === code);
                            if (item) {
                                item.price = newPrice;
                                priceOverrides[code] = newPrice;
                                localStorage.setItem('priceOverrides', JSON.stringify(priceOverrides));
                                calculateTotal();
                                updateCartDisplay();
                                saveCart();
                            }
                        }
                    }, 500));
                });

                document.querySelectorAll('.discount-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        resetIdleTimer();
                        const code = e.target.dataset.code;
                        const newDiscount = parseFloat(e.target.value);
                        if (!isNaN(newDiscount) && newDiscount >= 0) {
                            const item = cart.find(item => item.code === code);
                            if (item) {
                                item.discount = newDiscount;
                                item.isManual = true; 
                                e.target.classList.add('manual-locked');
                                e.target.classList.remove('class-rule-active');
                                calculateTotal();
                            }
                        }
                    });
                    input.addEventListener('change', () => {
                        saveCart();
                        updateCartDisplay();
                    });
                });

                document.querySelectorAll('.sync-check').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            const targetClass = e.target.dataset.class;
                            const targetCode = e.target.dataset.code;
                            const triggerItem = cart.find(i => i.code === targetCode);
                            
                            if (triggerItem && targetClass) {
                                const newRuleValue = triggerItem.discount;
                                sessionRules[targetClass] = newRuleValue;
                                localStorage.setItem('sessionRules', JSON.stringify(sessionRules));

                                cart.forEach(item => {
                                    if (item.class === targetClass) {
                                        item.isManual = false; 
                                        item.discount = newRuleValue;
                                    }
                                });
                                
                                alert(`已設定分類 [${targetClass}] 全部為 ${newRuleValue} 折`);
                                calculateTotal();
                                updateCartDisplay();
                                saveCart();
                            }
                        }
                    });
                });
            };

            const calculateTotal = () => {
                let total = 0;
                cart = cart.filter(item => item.quantity !== 0);
                cart.forEach(item => {
                    const discountedPrice = item.price * item.quantity * (item.discount / 100);
                    total += discountedPrice;
                });
                totalAmountElement.textContent = Math.round(total);
                calculateChange();
            };

            const calculateChange = () => {
                const totalAmount = parseFloat(totalAmountElement.textContent);
                const paidAmount = parseFloat(paidAmountInput.value);
                const change = paidAmount - totalAmount;
                changeAmountElement.textContent = isNaN(change) ? "0" : Math.round(change);
            };

            paidAmountInput.addEventListener('input', calculateChange);
            const saveCart = () => { localStorage.setItem('cart', JSON.stringify(cart)); };
            const saveSummary = () => {
                localStorage.setItem('clients', JSON.stringify(clients));
                localStorage.setItem('overallSummary', JSON.stringify(overallSummary));
                localStorage.setItem('clientCounter', JSON.stringify(clientCounter));
            };

            const handleCulturalCoinCheckout = () => {
                if (cart.length === 0) {
                    if (!hasShownEmptyCartAlert) { alert('購物車為空，無法結帳'); POSAudio.error(); hasShownEmptyCartAlert = true; }
                    return;
                }
                hasShownEmptyCartAlert = false;
                const totalAmount = parseFloat(totalAmountElement.textContent);
                let coinAmountStr = prompt(`訂單總額為 ${totalAmount} 元。\n請輸入文化幣支付金額：`, totalAmount);
                if (coinAmountStr === null) return;
                let coinAmount = parseInt(coinAmountStr);
                if (isNaN(coinAmount) || coinAmount < 0) { alert("請輸入有效的金額！"); POSAudio.error(); return; }
                if (coinAmount > totalAmount) { alert("文化幣金額不能大於訂單總額！"); POSAudio.error(); coinAmount = totalAmount; }

                const cashAmount = totalAmount - coinAmount;
                let methodStr = "";
                if (cashAmount > 0 && coinAmount > 0) methodStr = `文化幣(${coinAmount}) + 現金(${cashAmount})`;
                else if (coinAmount > 0 && cashAmount === 0) methodStr = `文化幣全額(${coinAmount})`;
                else methodStr = `現金(${totalAmount})`;

                triggerButtonAnimation(btnF9);
                performCheckout(methodStr, true); 
            };

            const triggerButtonAnimation = (btnElement) => {
                if(!btnElement) return;
                btnElement.classList.add('animate-click');
                setTimeout(() => { btnElement.classList.remove('animate-click'); }, 500);
            };

            const performCheckout = (paymentMethod, isComposite = false) => {
                if (cart.length === 0) {
                    if (!hasShownEmptyCartAlert) { alert('購物車為空，無法結帳'); POSAudio.error(); hasShownEmptyCartAlert = true; }
                    return;
                }
                hasShownEmptyCartAlert = false;

                if (!isComposite) {
                     if(paymentMethod === '信用卡') triggerButtonAnimation(btnF7);
                     if(paymentMethod === 'LINE PAY') triggerButtonAnimation(btnF8);
                     if(paymentMethod === '現金') triggerButtonAnimation(btnF10);
                }
                
                POSAudio.success();
                const totalAmount = parseFloat(totalAmountElement.textContent);
                const clientId = generateClientId();
                const mERI = generateERI('master');
                
                clients[clientId] = {
                    id: clientId,
                    eri: mERI,
                    amount: totalAmount,
                    paymentMethod: paymentMethod, 
                    items: cart.map(i => ({...i, detailERI: generateERI('detail')})),
                    isValid: true,
                    ts: new Date().getTime().toString().slice(-12)
                };

                cart.forEach(item => {
                    if (!overallSummary[item.code]) {
                        overallSummary[item.code] = { code: item.code, name: item.name, totalQuantity: 0, totalAmount: 0 };
                    }
                    overallSummary[item.code].totalQuantity += item.quantity;
                    overallSummary[item.code].totalAmount += item.price * item.quantity * (item.discount / 100);
                });

                priceOverrides = {}; 
                localStorage.setItem('priceOverrides', JSON.stringify(priceOverrides));

                cart = [];
                updateCartDisplay();
                calculateTotal();
                updateSummaryTable();
                saveSummary();
                clientCounter++;
                localStorage.setItem('clientCounter', JSON.stringify(clientCounter)); 
                localStorage.removeItem('cart');
                productCodeInput.focus(); 
                paidAmountInput.value = 1000;
            };

            btnF7.addEventListener('click', () => performCheckout('信用卡'));
            btnF8.addEventListener('click', () => performCheckout('LINE PAY'));
            btnF9.addEventListener('click', () => handleCulturalCoinCheckout()); 
            btnF10.addEventListener('click', () => performCheckout('現金'));

            document.addEventListener('keydown', (e) => {
                if (cart.length > 0) {
                    switch(e.key) {
                        case 'F10': e.preventDefault(); performCheckout('現金'); break;
                        case 'F9': e.preventDefault(); handleCulturalCoinCheckout(); break;
                        case 'F8': e.preventDefault(); performCheckout('LINE PAY'); break;
                        case 'F7': e.preventDefault(); performCheckout('信用卡'); break;
                    }
                }
            });

            const parseProductInput = (input) => {
                const pattern = /^(\d+)\*([\w-]+)$/;
                const match = input.match(pattern);
                if (match) return { quantity: parseInt(match[1], 10), code: match[2] };
                return null;
            };

            productCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const codeOrBarcode = e.target.value.trim().toLowerCase();
                    const parsedInput = parseProductInput(codeOrBarcode);
                    let product = null;

                    if (parsedInput) {
                        product = products[parsedInput.code];
                        if (product) product.quantity = parsedInput.quantity;
                    } else {
                        product = Object.values(products).find(p => p.code.toLowerCase() === codeOrBarcode || (p.barcode && p.barcode.includes(codeOrBarcode)));
                    }

                    if (product) {
                        addProductToCart(product.code);
                        e.target.value = ''; // 清空
                        productInfoElement.textContent = `已加入: ${product.name}`;
                    } else {
                        alert('找不到商品'); POSAudio.error();
                    }
                }
            });

            productCodeInput.addEventListener('input', (e) => {
                const codeOrBarcode = e.target.value.trim().toLowerCase();
                // 僅做提示，不做加入動作
                const product = Object.values(products).find(product => product.code.toLowerCase() === codeOrBarcode || (product.barcode && product.barcode.includes(codeOrBarcode)));
                if (product) productInfoElement.textContent = `${product.name} ${Math.round(product.price)}元`;
                else productInfoElement.textContent = '';
            });

            keywordSearchInput.addEventListener('input', (e) => {
                const keywords = e.target.value.trim().toLowerCase().split(' ');
                const matchedProducts = Object.values(products).filter(product => 
                    keywords.every(keyword => 
                        product.name.toLowerCase().includes(keyword) ||
                        product.code.toLowerCase().includes(keyword) ||
                        (product.barcode && product.barcode.includes(keyword))
                    )
                );

                searchResultsElement.innerHTML = '';
                const displayProducts = matchedProducts.slice(0, 3); 

                displayProducts.forEach(product => {
                    const resultItem = document.createElement('div');
                    resultItem.textContent = `${product.code} ｜ ${product.name} ｜ ${Math.round(product.price)}元`;
                    const selectButton = document.createElement('button');
                    selectButton.textContent = '加入';
                    selectButton.style.marginLeft = "10px";
                    selectButton.addEventListener('click', () => {
                        addProductToCart(product.code);
                        productInfoElement.textContent = `${product.name}`;
                        searchResultsElement.innerHTML = '';
                        keywordSearchInput.value = ''; 
                    });
                    resultItem.appendChild(selectButton);
                    searchResultsElement.appendChild(resultItem);
                });
            });

            const calculatePaymentStats = () => {
                let stats = { cash: 0, credit: 0, linepay: 0, culture: 0 };
                Object.values(clients).forEach(client => {
                    if(!client.isValid) return; 

                    const method = client.paymentMethod || '現金';
                    if (method === '信用卡') stats.credit += client.amount;
                    else if (method === 'LINE PAY') stats.linepay += client.amount;
                    else if (method === '現金') stats.cash += client.amount;
                    else if (method.includes('文化幣')) {
                        const coinMatch = method.match(/文化幣.*?\((\d+)\)/);
                        if (coinMatch && coinMatch[1]) stats.culture += parseInt(coinMatch[1]);
                        const cashMatch = method.match(/現金\((\d+)\)/);
                        if (cashMatch && cashMatch[1]) stats.cash += parseInt(cashMatch[1]);
                    }
                });
                return stats;
            };

            const updateSummaryTable = () => {
                summaryTableBody.innerHTML = '';
                overallSummaryTableBody.innerHTML = '';

                let tempOverall = {};
                let tempSysCash = 0;
                
                Object.values(clients).sort((a,b) => b.id.localeCompare(a.id)).forEach(client => {
                    const row = document.createElement('tr');
                    const method = client.paymentMethod || '現金';
                    
                    if(!client.isValid) {
                        row.classList.add('void-order');
                    } else {
                        if (method.includes("現金")) {
                            // 若是混合支付，需解析出現金部分
                            if(method.includes("文化幣")) {
                                const cashMatch = method.match(/現金\((\d+)\)/);
                                if (cashMatch && cashMatch[1]) tempSysCash += parseInt(cashMatch[1]);
                            } else {
                                tempSysCash += client.amount;
                            }
                        }
                        client.items.forEach(item => {
                            if (!tempOverall[item.code]) tempOverall[item.code] = { code: item.code, name: item.name, totalQuantity: 0, totalAmount: 0 };
                            tempOverall[item.code].totalQuantity += item.quantity;
                            tempOverall[item.code].totalAmount += item.price * item.quantity * (item.discount / 100);
                        });
                    }

                    row.innerHTML = `
                        <td><a href="#" class="client-link" data-client-id="${client.id}">${client.id}</a> ${!client.isValid ? '(已作廢)' : ''}</td>
                        <td>${Math.round(client.amount)}</td>
                        <td>
                            <button class="btn-change-pay" data-client-id="${client.id}">${method}</button>
                        </td>
                        <td class="btn-action-group">
                            ${client.isValid ? `<button class="btn-void" data-client-id="${client.id}">作廢</button>` : `<button class="btn-void" data-client-id="${client.id}">復原</button>`}
                            <button class="btn-del" data-client-id="${client.id}">刪除</button>
                        </td>
                    `;
                    summaryTableBody.appendChild(row);
                });

                overallSummary = tempOverall; 

                const sortedSummary = Object.values(overallSummary).sort((a, b) => a.code.localeCompare(b.code));
                sortedSummary.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.code}</td>
                        <td>${item.name}</td>
                        <td>${item.totalQuantity}</td>
                        <td>${Math.round(item.totalAmount)}</td>
                    `;
                    overallSummaryTableBody.appendChild(row);
                });

                const overallTotalAmount = sortedSummary.reduce((sum, item) => sum + item.totalAmount, 0);
                overallTotalAmountElement.textContent = Math.round(overallTotalAmount);

                const validOrders = Object.values(clients).filter(c => c.isValid).length;
                const averageOrderAmount = validOrders > 0 ? Math.round(overallTotalAmount / validOrders) : 0;
                totalOrdersElement.textContent = validOrders;
                averageAmountElement.textContent = averageOrderAmount;
                
                const stats = calculatePaymentStats();
                paymentStatsElement.innerHTML = `
                    <div class="stat-item">現金: <b>${stats.cash}</b></div>
                    <div class="stat-item">刷卡: <b>${stats.credit}</b></div>
                    <div class="stat-item">LINE: <b>${stats.linepay}</b></div>
                    <div class="stat-item">文化: <b>${stats.culture}</b></div>
                `;

                sysCashTotalEl.textContent = stats.cash;
                updateAccountingCalc(); 

                attachHistoryEvents();
            };

            const attachHistoryEvents = () => {
                // 修改付款方式 (開啟 Modal)
                document.querySelectorAll('.btn-change-pay').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const clientId = e.target.dataset.clientId;
                        const client = clients[clientId];
                        if(!client.isValid) return alert("已作廢訂單無法修改");
                        openPaymentModal(clientId);
                    });
                });

                document.querySelectorAll('.btn-void').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const clientId = e.target.dataset.clientId;
                        clients[clientId].isValid = !clients[clientId].isValid;
                        saveSummary();
                        updateSummaryTable();
                    });
                });

                document.querySelectorAll('.btn-del').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const clientId = e.target.dataset.clientId;
                        if (confirm('【警告】這將完全刪除此筆資料，無法復原。確定要刪除嗎？')) {
                            delete clients[clientId];
                            saveSummary();
                            updateSummaryTable();
                        }
                    });
                });

                document.querySelectorAll('.client-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const clientId = e.target.dataset.clientId;
                        showClientDetails(clientId);
                    });
                });
            };

            // --- Modal 控制邏輯 ---
            window.openPaymentModal = (clientId) => {
                editingClientId = clientId;
                paymentModal.style.display = 'flex';
            };

            window.closePaymentModal = () => {
                editingClientId = null;
                paymentModal.style.display = 'none';
            };

            window.selectPaymentMethod = (methodType) => {
                if (!editingClientId) return;
                const client = clients[editingClientId];
                let finalMethod = methodType;

                if (methodType === '文化幣') {
                    const coinAmt = prompt(`目前總金額 ${client.amount}，請輸入文化幣金額 (剩餘轉為現金)：`, client.amount);
                    if (coinAmt && !isNaN(coinAmt)) {
                        const c = parseInt(coinAmt);
                        if (c < 0 || c > client.amount) { alert("金額輸入錯誤"); return; }
                        const cash = client.amount - c;
                        finalMethod = `文化幣(${c}) + 現金(${cash})`;
                    } else { return; }
                }

                clients[editingClientId].paymentMethod = finalMethod;
                saveSummary();
                updateSummaryTable();
                closePaymentModal();
            };

            const showClientDetails = (clientId) => {
                const client = clients[clientId];
                if (client) {
                    const method = client.paymentMethod || '現金';
                    const items = client.items.map(item => `${item.code} ｜ ${item.name} x ${item.quantity} (${Math.round(item.price*item.quantity)})`).join('\n');
                    alert(`客戶：${clientId} ${!client.isValid?'(已作廢)':''}\n付款方式：${method}\n\n購買商品：\n${items}`);
                }
            };

            // --- 記帳模式邏輯 ---
            window.clearAccountingInputs = () => {
                document.querySelectorAll('.acct-count.current').forEach(input => {
                    input.value = '';
                    localStorage.removeItem(`acct_cur_${input.dataset.val}`);
                });
                updateAccountingCalc();
            };

            const updateAccountingCalc = () => {
                let drawerTotal = 0;
                let initialTotal = 0;

                // 左欄: 現有盤點
                document.querySelectorAll('.acct-count.current').forEach(input => {
                    const val = parseInt(input.dataset.val);
                    const count = parseInt(input.value) || 0;
                    drawerTotal += val * count;
                });

                // 右欄: 初始金額
                document.querySelectorAll('.acct-count.initial').forEach(input => {
                    const val = parseInt(input.dataset.val);
                    const count = parseInt(input.value) || 0;
                    initialTotal += val * count;
                });

                const expenses = parseInt(expensesCashInput.value) || 0;
                const netCash = drawerTotal - initialTotal + expenses; 
                
                // 更新顯示
                calcDrawerTotalEl.textContent = drawerTotal;
                calcInitialEl.textContent = initialTotal;
                calcExpensesEl.textContent = expenses;
                calcNetCashEl.textContent = netCash;

                const sysCash = parseInt(sysCashTotalEl.textContent) || 0;
                const diff = netCash - sysCash;
                
                cashDiffEl.textContent = diff;
                if(diff === 0) {
                    cashDiffEl.style.color = 'green';
                    cashDiffRow.style.backgroundColor = '#e8f5e9';
                } else {
                    cashDiffEl.style.color = 'red';
                    cashDiffRow.style.backgroundColor = '#ffebee';
                }
            };

            // 備份與還原
            backupBtn.addEventListener('click', () => {
                const backupData = {
                    cart, clients, overallSummary, clientCounter, sessionRules, priceOverrides,
                    notes: notesElement.value,
                    timestamp: new Date().toISOString()
                };
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pos_backup_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });

            restoreBtn.addEventListener('click', () => {
                if (confirm('注意：還原將覆蓋目前訂單資料。')) importFileInput.click();
            });

            importFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.clients) {
                            localStorage.setItem('cart', JSON.stringify(data.cart || []));
                            localStorage.setItem('clients', JSON.stringify(data.clients || {}));
                            localStorage.setItem('overallSummary', JSON.stringify(data.overallSummary || {})); 
                            localStorage.setItem('clientCounter', JSON.stringify(data.clientCounter || 1));
                            localStorage.setItem('sessionRules', JSON.stringify(data.sessionRules || {}));
                            localStorage.setItem('priceOverrides', JSON.stringify(data.priceOverrides || {}));
                            localStorage.setItem('notes', data.notes || '');
                            alert('還原成功！');
                            location.reload();
                        }
                    } catch (err) { alert('備份檔案格式錯誤'); }
                };
                reader.readAsText(file);
                importFileInput.value = '';
            });

            // CSV 匯出 (標準版)
            exportCsvBtn.addEventListener('click', () => {
                try {
                    updateSummaryTable();
                    const notes = localStorage.getItem('notes') || '無備註';
                    const stats = calculatePaymentStats();
                    const overallTotalAmount = Object.values(overallSummary).reduce((sum, item) => sum + item.totalAmount, 0);

                    const summaryRows = [
                        ['客戶名稱', '消費金額', '付款方式', '狀態'], 
                        ...Object.values(clients).map(client => [
                            client.id, Math.round(client.amount), client.paymentMethod || '現金', client.isValid ? '有效' : '已作廢'
                        ]),
                        [], ['商品代碼', '名稱', '總數量', '總金額'],
                        ...Object.values(overallSummary).map(item => [item.code, item.name, item.totalQuantity, Math.round(item.totalAmount)]),
                        [], ['總金額', Math.round(overallTotalAmount)],
                        ['現金總收', stats.cash], ['信用卡總收', stats.credit], ['LINE PAY總收', stats.linepay], ['文化幣總收', stats.culture],
                        [], ['備註', notes], [],
                        ['盤點記錄'], ['盤點現金總額', calcDrawerTotalEl.textContent], ['初始備用金', calcInitialEl.textContent],
                        ['支出憑證', calcExpensesEl.textContent], ['實際現金營收', calcNetCashEl.textContent], ['差異金額', cashDiffEl.textContent]
                    ];

                    const detailsRows = [
                        ['詳細內容：'], ['客戶名稱', '付款方式', '商品名稱', '數量', '單價', '折扣', '小計', '狀態'],
                        ...Object.values(clients).flatMap(client =>
                            client.items.map(item => [
                                client.id, client.paymentMethod || '現金', item.name, item.quantity, Math.round(item.price),
                                `${item.discount}%`, Math.round(item.price * item.quantity * (item.discount / 100)), client.isValid ? '有效' : '已作廢'
                            ])
                        )
                    ];

                    const csvContent = [...summaryRows, ...detailsRows].map(e => e.join(",")).join("\n");
                    const blob = new Blob([`\ufeff${csvContent}`], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `sales_report_POS_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                } catch (error) { alert('CSV匯出錯誤'); }
            });

// --- PILOT 會計匯出 (修正版 v4 - 格式最終修復) ---
            exportPilotBtn.addEventListener('click', () => {
                // 1. 基礎設定
                const codeFixed = "19890107";     // 固定單號
                const custCode = "0002";          // 客戶代碼 (固定四碼)
                const whCode = "0000";            // 倉庫代碼 (固定四碼)
                const staffCode = "0002";         // 員工/部門代碼
                
                const now = new Date();
                const date = now.getFullYear() + '/' + 
                             String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                             String(now.getDate()).padStart(2, '0');
                
                // LASTUPD: YYMMDDHHMMSS
                const yy = String(now.getFullYear()).slice(-2);
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                const hh = String(now.getHours()).padStart(2, '0');
                const mi = String(now.getMinutes()).padStart(2, '0');
                const ss = String(now.getSeconds()).padStart(2, '0');
                const ts = yy + mm + dd + hh + mi + ss;

                // 2. 定義標頭 (Headers)
                let s1 = [["ERI","CODE","STAFF","CUST","SDATE","CURR","RATE","PROJNO","GWN","ADDR","TAX","AMT","PLUSSUB","TOTAL","QTY","EDITOR","MEMO","REMARK","ARTICLE","TAXCATE","INVCATE","INVDATE","INVNO","BILDATE","RADVDATE","COST","DPTNO","ACCNO","TYPE","SRCERI","SCRUTINY","PRNIMMED","PRNONCE","ACCDESC","ACCGEN","ACNT","INVAMT","COMPNO","REFNO","PRINTX","BILCUST","BANK","INVNAME","CMPID","PAYCASH","NORCV","CONTACT","TEL","EINVFLAG","APCODE","LASTUPD","POSCODE","POSREMARK1","POSREMARK2","STIME"]];
                
                let s2 = [["ERI","MASTERI","SRCERI","STAFF","CUST","GWN","PROD","SDATE","TYPE","CODE","SERIAL","SPEC","QTY","UNIT","PRICE","AMT","REALQTY","SUBQTY","REMARK","PRODDESC","QTYSTR","CURR","RATE","STDPRC","DISCOUNT","PROJNO","INVNO","INVQTY","SAMPLE","INVRETURN","VPNO","VLIDDATE","REFNO","INVPRC","INVAMT","INVAMT1","GIFT","MFLAG","SUBAMT","APCODE","LASTUPD","POSREMARK1","POSREMARK2"]];
                
                let v1 = [["ERI","SRCERI","SERIAL","CODE","SUBJNO","OP","AMT","REMARK","APCODE","LASTUPD"]];

                // 3. 填入資料 (關鍵修正：空欄位使用 null)
                Object.values(clients).forEach(c => {
                    if(!c.isValid) return; 
                    
                    const mERI = c.eri || generateERI('master');
                    const gross = c.items.reduce((a,b)=>a+(b.price*b.quantity), 0);
                    const qtyTotal = c.items.reduce((a,b)=>a+b.quantity, 0);

                    // --- S1: 主檔 ---
                    s1.push([
                        mERI, codeFixed, staffCode, custCode, date, "NTD", 1, null, whCode, null, 
                        0, Math.round(gross), Math.round(c.amount-gross), Math.round(c.amount), qtyTotal, "POS_USER", null, "書展匯入", null, 3, 
                        3, null, null, date, date, Math.round(c.amount), 0, null, 0, null, 
                        null, 0, 0, null, 0, null, 0, 0, null, 0, 
                        custCode, null, "書展", null, 1, 0, null, null, 0, null, 
                        ts, null, null, null, null
                    ]);

                    // --- S2: 明細檔 (關鍵修正) --- 
                    // 修正說明：所有原本為 "" 的欄位都改為 null，避免 CSV 輸出為 "", 導致欄位判讀位移
                    c.items.forEach((it, idx) => {
                        const dERI = it.detailERI || generateERI('detail');
                        s2.push([
                            dERI,           // ERI
                            mERI,           // MASTERI
                            null,           // SRCERI
                            staffCode,      // STAFF
                            custCode,       // CUST
                            whCode,         // GWN
                            it.code,        // PROD (商品)
                            date,           // SDATE
                            0,              // TYPE
                            codeFixed,      // CODE (單號)
                            idx,            // SERIAL
                            null,           // SPEC
                            it.quantity,    // QTY
                            "本",           // UNIT
                            it.price,       // PRICE
                            Math.round(it.price*it.quantity), // AMT
                            it.quantity,    // REALQTY
                            0, null, null,  // SUBQTY, REMARK, PRODDESC (改為 null)
                            it.quantity+"本", // QTYSTR
                            "NTD", 1,       // CURR, RATE
                            it.price,       // STDPRC
                            it.discount,    // DISCOUNT
                            null, null, 0, 0, 0, // PROJNO, INVNO (改為 null), INVQTY, SAMPLE, INVRETURN
                            null, date, null, 0, 0, 0, 0, 0, 0, null, // VPNO (改為 null), VLIDDATE...
                            ts, null, null  // LASTUPD, POSREMARK...
                        ]);
                    });

                    // --- V1: 傳票 ---
                    let payCode = "5"; 
                    let paySubj = "1144.355"; 
                    if (c.paymentMethod.includes("信用卡") || c.paymentMethod.includes("LINE")) { 
                        payCode = "16"; paySubj = "1144.358"; 
                    }
                    
                    v1.push([
                        generateERI('pay'), mERI, 0, payCode, paySubj, 0, -Math.round(c.amount), null, null, ts
                    ]);
                });

                // 4. 下載功能 (優化 CSV 格式)
                const downloadCSV = (data, filename) => {
                    let csv = data.map(row => 
                        row.map(v => {
                            // 修正：如果是 null 或 undefined，回傳空字串 (不加引號)，產生 ,, 效果
                            if (v === null || v === undefined) return "";
                            // 其他值強制加引號，確保文字格式正確 (如 "0002")
                            return `"${v}"`; 
                        }).join(",")
                    ).join("\r\n");

                    let blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
                    let a = document.createElement('a'); 
                    a.href = URL.createObjectURL(blob); 
                    a.download = filename; 
                    a.click();
                };

                downloadCSV(s1, "STKSALE1.csv");
                setTimeout(() => downloadCSV(s2, "STKSALE2.csv"), 500);
                setTimeout(() => downloadCSV(v1, "VCHRPLUS_SALE1.csv"), 1000);
            });
            
            // --- 啟動程序 ---
            loadDiscountRates(); 
            loadProducts().then(() => {
                updateCartDisplay();
                updateSummaryTable();
            });
            calculateChange(); 
        });
    </script>
</body>
</html>



